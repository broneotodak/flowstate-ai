<!DOCTYPE html>
<html>
<head>
    <title>Debug Timestamp Issue</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
    <style>
        body {
            font-family: monospace;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
        }
        .debug-info {
            background: #f5f5f5;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .timestamp {
            background: #e0e0e0;
            padding: 5px;
            margin: 5px 0;
        }
        button {
            background: #2196f3;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>üïê Debug Timestamp Issue</h1>
    
    <input type="password" id="serviceKey" placeholder="Service Role Key">
    <button onclick="debugTime()">Debug Time</button>
    
    <div id="results"></div>

    <script>
        // Copy the formatTime function from dashboard
        function formatTime(timestamp) {
            if (!timestamp) return 'Never';
            
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
            if (diff < 604800000) return `${Math.floor(diff / 86400000)}d ago`;
            
            return date.toLocaleDateString();
        }
        
        async function debugTime() {
            const serviceKey = document.getElementById('serviceKey').value;
            if (!serviceKey) return alert('Enter service key');
            
            const supabase = window.supabase.createClient(
                'https://uzamamymfzhelvkwpvgt.supabase.co',
                serviceKey
            );
            
            // Get current context
            const { data: context, error } = await supabase
                .from('current_context')
                .select('*')
                .eq('user_id', 'neo_todak')
                .single();
            
            if (error) {
                document.getElementById('results').innerHTML = `Error: ${error.message}`;
                return;
            }
            
            const timestamp = context.last_updated;
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            let html = '<div class="debug-info">';
            html += '<h2>Database Record:</h2>';
            html += `<div class="timestamp">Raw timestamp: ${timestamp}</div>`;
            html += `<div class="timestamp">Parsed date: ${date.toString()}</div>`;
            html += `<div class="timestamp">ISO string: ${date.toISOString()}</div>`;
            html += '</div>';
            
            html += '<div class="debug-info">';
            html += '<h2>Current Time:</h2>';
            html += `<div class="timestamp">Now: ${now.toString()}</div>`;
            html += `<div class="timestamp">Now ISO: ${now.toISOString()}</div>`;
            html += `<div class="timestamp">Timezone: ${Intl.DateTimeFormat().resolvedOptions().timeZone}</div>`;
            html += '</div>';
            
            html += '<div class="debug-info">';
            html += '<h2>Calculations:</h2>';
            html += `<div class="timestamp">Difference (ms): ${diff}</div>`;
            html += `<div class="timestamp">Difference (seconds): ${Math.floor(diff / 1000)}</div>`;
            html += `<div class="timestamp">Difference (minutes): ${Math.floor(diff / 60000)}</div>`;
            html += `<div class="timestamp">Difference (hours): ${Math.floor(diff / 3600000)}</div>`;
            html += '</div>';
            
            html += '<div class="debug-info">';
            html += '<h2>formatTime() Result:</h2>';
            html += `<div class="timestamp" style="font-size: 24px; font-weight: bold;">${formatTime(timestamp)}</div>`;
            html += '</div>';
            
            html += '<div class="debug-info">';
            html += '<h2>Test Different Timestamps:</h2>';
            const testNow = new Date().toISOString();
            const test5min = new Date(Date.now() - 5 * 60000).toISOString();
            const test1hour = new Date(Date.now() - 3600000).toISOString();
            const test8hours = new Date(Date.now() - 8 * 3600000).toISOString();
            
            html += `<div class="timestamp">Now (${testNow}): ${formatTime(testNow)}</div>`;
            html += `<div class="timestamp">5 min ago (${test5min}): ${formatTime(test5min)}</div>`;
            html += `<div class="timestamp">1 hour ago (${test1hour}): ${formatTime(test1hour)}</div>`;
            html += `<div class="timestamp">8 hours ago (${test8hours}): ${formatTime(test8hours)}</div>`;
            html += '</div>';
            
            document.getElementById('results').innerHTML = html;
        }
        
        // Auto-fill service key
        document.getElementById('serviceKey').value = localStorage.getItem('flowstate_service_key') || '';
    </script>
</body>
</html>