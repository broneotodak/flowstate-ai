#!/bin/bash

echo "==================================="
echo "FlowState Browser Extension Installer"
echo "==================================="
echo

# Set extension directory
EXTENSION_DIR="$HOME/Library/Application Support/FlowState/browser-extension"

# Create directory
echo "Creating extension directory..."
mkdir -p "$EXTENSION_DIR"

# Extract extension files (embedded in script)
echo "Extracting extension files..."
extract_files() {
    echo "Creating manifest.json..."
    cat << 'EOF' | base64 -d > "$EXTENSION_DIR/manifest.json"
ewogICJtYW5pZmVzdF92ZXJzaW9uIjogMywKICAibmFtZSI6ICJGbG93U3RhdGUgQ29udGV4dCBUcmFja2VyIiwKICAidmVyc2lvbiI6ICIxLjAuMSIsCiAgImRlc2NyaXB0aW9uIjogIkF1dG9tYXRpY2FsbHkgdHJhY2tzIHlvdXIgY3VycmVudCBwcm9qZWN0IGNvbnRleHQgYmFzZWQgb24gYnJvd3NlciBhY3Rpdml0eSIsCiAgInBlcm1pc3Npb25zIjogWwogICAgInRhYnMiLAogICAgInN0b3JhZ2UiLAogICAgImFsYXJtcyIKICBdLAogICJob3N0X3Blcm1pc3Npb25zIjogWwogICAgImh0dHBzOi8vZ2l0aHViLmNvbS8qIiwKICAgICJodHRwczovL2NsYXVkZS5haS8qIiwKICAgICJodHRwOi8vbG9jYWxob3N0LyoiLAogICAgImh0dHBzOi8vKi5zdXBhYmFzZS5jby8qIgogIF0sCiAgImJhY2tncm91bmQiOiB7CiAgICAic2VydmljZV93b3JrZXIiOiAiYmFja2dyb3VuZC5qcyIKICB9LAogICJhY3Rpb24iOiB7CiAgICAiZGVmYXVsdF9wb3B1cCI6ICJwb3B1cC5odG1sIiwKICAgICJkZWZhdWx0X2ljb24iOiB7CiAgICAgICIxNiI6ICJpY29uMTYucG5nIiwKICAgICAgIjQ4IjogImljb240OC5wbmciLAogICAgICAiMTI4IjogImljb24xMjgucG5nIgogICAgfQogIH0sCiAgImljb25zIjogewogICAgIjE2IjogImljb24xNi5wbmciLAogICAgIjQ4IjogImljb240OC5wbmciLAogICAgIjEyOCI6ICJpY29uMTI4LnBuZyIKICB9Cn0=
EOF

    echo "Creating background.js..."
    cat << 'EOF' | base64 -d > "$EXTENSION_DIR/background.js"
Ly8gRmxvd1N0YXRlIEJyb3dzZXIgRXh0ZW5zaW9uIC0gQmFja2dyb3VuZCBTZXJ2aWNlIFdvcmtlcgoKY29uc3QgU1VQQUJBU0VfVVJMID0gJ2h0dHBzOi8vdXphbWFteW1memhlbHZrd3B2Z3Quc3VwYWJhc2UuY28nOwpjb25zdCBDSEVDS19JTlRFUlZBTCA9IDMwMDAwOyAvLyBDaGVjayBldmVyeSAzMCBzZWNvbmRzCmNvbnN0IEFDVElWSVRZX0lOVEVSVkFMID0gMzAwMDAwOyAvLyBMb2cgYWN0aXZpdHkgZXZlcnkgNSBtaW51dGVzCgpsZXQgbGFzdEFjdGl2aXR5ID0ge307CmxldCBjdXJyZW50Q29udGV4dCA9IHsKICBwcm9qZWN0OiBudWxsLAogIHRhc2s6IG51bGwsCiAgY29uZmlkZW5jZTogMAp9OwoKLy8gUHJvamVjdCBkZXRlY3Rpb24gcGF0dGVybnMKY29uc3QgUFJPSkVDVF9QQVRURVJOUyA9IHsKICAnRmxvd1N0YXRlJzogWwogICAgL2Zsb3dzdGF0ZS9pLAogICAgL2Zsb3ctc3RhdGUvaSwKICAgIC90b2Rhay1haS9pLAogICAgL2VtYmVkZGluZ3MvaSwKICAgIC9jb250ZXh0IGRldGVjdGlvbi9pCiAgXSwKICAnQ2xhdWRlTic6IFsKICAgIC9jbGF1ZGVuL2ksCiAgICAvY2xhdWRlXC5haS4qZGFzaGJvYXJkL2ksCiAgICAvYW50aHJvcGljLipkYXNoYm9hcmQvaQogIF0sCiAgLy8gQXV0by1kZXRlY3QgYW55IEdpdEh1YiBwcm9qZWN0CiAgJ0dpdEh1Yic6IFsKICAgIC9naXRodWJcLmNvbS9pCiAgXQp9OwoKLy8gVGFzayBkZXRlY3Rpb24gcGF0dGVybnMgYmFzZWQgb24gVVJMcyBhbmQgdGl0bGVzCmNvbnN0IFRBU0tfUEFUVEVSTlMgPSB7CiAgJ2dpdGh1Yi5jb20nOiB7CiAgICAnL2lzc3Vlcy8nOiAnTWFuYWdpbmcgaXNzdWVzJywKICAgICcvcHVsbC8nOiAnUmV2aWV3aW5nIHB1bGwgcmVxdWVzdHMnLAogICAgJy9jb21taXQvJzogJ1Jldmlld2luZyBjb21taXRzJywKICAgICcvdHJlZS8nOiAnQnJvd3NpbmcgY29kZScsCiAgICAnL2Jsb2IvJzogJ1JlYWRpbmcgY29kZScsCiAgICAnL2VkaXQvJzogJ0VkaXRpbmcgY29kZScsCiAgICAnL25ldy8nOiAnQ3JlYXRpbmcgbmV3IGZpbGUnCiAgfSwKICAnY2xhdWRlLmFpJzogewogICAgJ0Zsb3dTdGF0ZSc6ICdBSSBjb252ZXJzYXRpb24gYWJvdXQgRmxvd1N0YXRlJywKICAgICdlbWJlZGRpbmcnOiAnV29ya2luZyBvbiBlbWJlZGRpbmdzJywKICAgICdjb250ZXh0JzogJ0ltcHJvdmluZyBjb250ZXh0IGRldGVjdGlvbicsCiAgICAndHJhY2tpbmcnOiAnSW1wbGVtZW50aW5nIGFjdGl2aXR5IHRyYWNraW5nJwogIH0sCiAgJ2xvY2FsaG9zdCc6IHsKICAgICc6MzAwMCc6ICdMb2NhbCBkZXZlbG9wbWVudCcsCiAgICAnOjgwODAnOiAnVGVzdGluZyBhcHBsaWNhdGlvbicsCiAgICAnOjUxNzMnOiAnVml0ZSBkZXZlbG9wbWVudCcKICB9Cn07CgovLyBJbml0aWFsaXplIGV4dGVuc2lvbgpjaHJvbWUucnVudGltZS5vbkluc3RhbGxlZC5hZGRMaXN0ZW5lcigoKSA9PiB7CiAgY29uc29sZS5sb2coJ0Zsb3dTdGF0ZSBDb250ZXh0IFRyYWNrZXIgaW5zdGFsbGVkJyk7CiAgCiAgLy8gU2V0IHVwIGFsYXJtcyBmb3IgcGVyaW9kaWMgY2hlY2tzCiAgY2hyb21lLmFsYXJtcy5jcmVhdGUoJ2NoZWNrQ29udGV4dCcsIHsgcGVyaW9kSW5NaW51dGVzOiAwLjUgfSk7CiAgY2hyb21lLmFsYXJtcy5jcmVhdGUoJ2xvZ0FjdGl2aXR5JywgeyBwZXJpb2RJbk1pbnV0ZXM6IDUgfSk7CiAgCiAgLy8gTG9hZCBzYXZlZCBjb25maWd1cmF0aW9uCiAgY2hyb21lLnN0b3JhZ2UubG9jYWwuZ2V0KFsnc2VydmljZUtleScsICdlbmFibGVkJ10sIChkYXRhKSA9PiB7CiAgICBpZiAoIWRhdGEuc2VydmljZUtleSkgewogICAgICBjb25zb2xlLmxvZygnU2VydmljZSBrZXkgbm90IGNvbmZpZ3VyZWQnKTsKICAgIH0KICB9KTsKfSk7CgovLyBMaXN0ZW4gZm9yIGFsYXJtIGV2ZW50cwpjaHJvbWUuYWxhcm1zLm9uQWxhcm0uYWRkTGlzdGVuZXIoKGFsYXJtKSA9PiB7CiAgaWYgKGFsYXJtLm5hbWUgPT09ICdjaGVja0NvbnRleHQnKSB7CiAgICBjaGVja0N1cnJlbnRDb250ZXh0KCk7CiAgfSBlbHNlIGlmIChhbGFybS5uYW1lID09PSAnbG9nQWN0aXZpdHknKSB7CiAgICBsb2dDdXJyZW50QWN0aXZpdHkoKTsKICB9Cn0pOwoKLy8gTGlzdGVuIGZvciB0YWIgdXBkYXRlcwpjaHJvbWUudGFicy5vbkFjdGl2YXRlZC5hZGRMaXN0ZW5lcigoKSA9PiB7CiAgY2hlY2tDdXJyZW50Q29udGV4dCgpOwp9KTsKCmNocm9tZS50YWJzLm9uVXBkYXRlZC5hZGRMaXN0ZW5lcigodGFiSWQsIGNoYW5nZUluZm8sIHRhYikgPT4gewogIGlmIChjaGFuZ2VJbmZvLnN0YXR1cyA9PT0gJ2NvbXBsZXRlJykgewogICAgY2hlY2tDdXJyZW50Q29udGV4dCgpOwogIH0KfSk7CgovLyBNYWluIGNvbnRleHQgZGV0ZWN0aW9uIGZ1bmN0aW9uCmFzeW5jIGZ1bmN0aW9uIGNoZWNrQ3VycmVudENvbnRleHQoKSB7CiAgdHJ5IHsKICAgIC8vIEdldCBhbGwgdGFicwogICAgY29uc3QgdGFicyA9IGF3YWl0IGNocm9tZS50YWJzLnF1ZXJ5KHt9KTsKICAgIAogICAgLy8gQW5hbHl6ZSBhY3RpdmUgdGFicwogICAgY29uc3QgYWN0aXZlVGFiID0gdGFicy5maW5kKHRhYiA9PiB0YWIuYWN0aXZlKTsKICAgIGNvbnN0IHJlY2VudFRhYnMgPSB0YWJzLmZpbHRlcih0YWIgPT4gdGFiLmxhc3RBY2Nlc3NlZCAmJiAKICAgICAgKERhdGUubm93KCkgLSB0YWIubGFzdEFjY2Vzc2VkIDwgNjAwMDAwKSk7IC8vIExhc3QgMTAgbWludXRlcwogICAgCiAgICAvLyBEZXRlY3QgcHJvamVjdCBmcm9tIHRhYnMKICAgIGxldCBkZXRlY3RlZFByb2plY3QgPSBudWxsOwogICAgbGV0IGNvbmZpZGVuY2UgPSAwOwogICAgbGV0IHRhc2tEZXNjcmlwdGlvbiA9ICcnOwogICAgCiAgICAvLyBDaGVjayBhY3RpdmUgdGFiIGZpcnN0CiAgICBpZiAoYWN0aXZlVGFiKSB7CiAgICAgIGNvbnN0IGRldGVjdGlvbiA9IGRldGVjdFByb2plY3RGcm9tVGFiKGFjdGl2ZVRhYik7CiAgICAgIGlmIChkZXRlY3Rpb24ucHJvamVjdCkgewogICAgICAgIGRldGVjdGVkUHJvamVjdCA9IGRldGVjdGlvbi5wcm9qZWN0OwogICAgICAgIGNvbmZpZGVuY2UgPSBkZXRlY3Rpb24uY29uZmlkZW5jZTsKICAgICAgICB0YXNrRGVzY3JpcHRpb24gPSBkZXRlY3Rpb24udGFzazsKICAgICAgfQogICAgfQogICAgCiAgICAvLyBDaGVjayByZWNlbnQgdGFicyBpZiBubyBzdHJvbmcgbWF0Y2gKICAgIGlmIChjb25maWRlbmNlIDwgMC44KSB7CiAgICAgIGZvciAoY29uc3QgdGFiIG9mIHJlY2VudFRhYnMpIHsKICAgICAgICBjb25zdCBkZXRlY3Rpb24gPSBkZXRlY3RQcm9qZWN0RnJvbVRhYih0YWIpOwogICAgICAgIGlmIChkZXRlY3Rpb24uY29uZmlkZW5jZSA+IGNvbmZpZGVuY2UpIHsKICAgICAgICAgIGRldGVjdGVkUHJvamVjdCA9IGRldGVjdGlvbi5wcm9qZWN0OwogICAgICAgICAgY29uZmlkZW5jZSA9IGRldGVjdGlvbi5jb25maWRlbmNlOwogICAgICAgICAgdGFza0Rlc2NyaXB0aW9uID0gZGV0ZWN0aW9uLnRhc2s7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICAKICAgIC8vIFVwZGF0ZSBjb250ZXh0IGlmIGNoYW5nZWQgc2lnbmlmaWNhbnRseQogICAgaWYgKGRldGVjdGVkUHJvamVjdCAmJiAoCiAgICAgIGRldGVjdGVkUHJvamVjdCAhPT0gY3VycmVudENvbnRleHQucHJvamVjdCB8fAogICAgICBNYXRoLmFicyhjb25maWRlbmNlIC0gY3VycmVudENvbnRleHQuY29uZmlkZW5jZSkgPiAwLjIKICAgICkpIHsKICAgICAgY3VycmVudENvbnRleHQgPSB7CiAgICAgICAgcHJvamVjdDogZGV0ZWN0ZWRQcm9qZWN0LAogICAgICAgIHRhc2s6IHRhc2tEZXNjcmlwdGlvbiwKICAgICAgICBjb25maWRlbmNlOiBjb25maWRlbmNlLAogICAgICAgIHVybDogYWN0aXZlVGFiID8gYWN0aXZlVGFiLnVybCA6ICcnLAogICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpCiAgICAgIH07CiAgICAgIAogICAgICAvLyBVcGRhdGUgYmFkZ2UgdG8gc2hvdyBjdXJyZW50IHByb2plY3QKICAgICAgdXBkYXRlQmFkZ2UoZGV0ZWN0ZWRQcm9qZWN0KTsKICAgICAgCiAgICAgIC8vIFN0b3JlIGluIGxvY2FsIHN0b3JhZ2UKICAgICAgY2hyb21lLnN0b3JhZ2UubG9jYWwuc2V0KHsgY3VycmVudENvbnRleHQgfSk7CiAgICB9CiAgICAKICB9IGNhdGNoIChlcnJvcikgewogICAgY29uc29sZS5lcnJvcignRXJyb3IgY2hlY2tpbmcgY29udGV4dDonLCBlcnJvcik7CiAgfQp9CgovLyBEZXRlY3QgcHJvamVjdCBmcm9tIGEgc2luZ2xlIHRhYgpmdW5jdGlvbiBkZXRlY3RQcm9qZWN0RnJvbVRhYih0YWIpIHsKICBpZiAoIXRhYi51cmwgfHwgIXRhYi50aXRsZSkgewogICAgcmV0dXJuIHsgcHJvamVjdDogbnVsbCwgY29uZmlkZW5jZTogMCwgdGFzazogJycgfTsKICB9CiAgCiAgbGV0IHByb2plY3QgPSBudWxsOwogIGxldCBjb25maWRlbmNlID0gMDsKICBsZXQgdGFzayA9ICcnOwogIAogIC8vIENoZWNrIFVSTCBwYXR0ZXJucwogIGNvbnN0IHVybCA9IG5ldyBVUkwodGFiLnVybCk7CiAgCiAgLy8gR2l0SHViIHJlcG9zaXRvcnkgZGV0ZWN0aW9uCiAgaWYgKHVybC5ob3N0bmFtZSA9PT0gJ2dpdGh1Yi5jb20nKSB7CiAgICBjb25zdCBwYXRoUGFydHMgPSB1cmwucGF0aG5hbWUuc3BsaXQoJy8nKTsKICAgIGlmIChwYXRoUGFydHMubGVuZ3RoID49IDMpIHsKICAgICAgY29uc3QgcmVwb05hbWUgPSBwYXRoUGFydHNbMl07CiAgICAgIAogICAgICAvLyBDaGVjayBpZiBpdCdzIGEga25vd24gcHJvamVjdAogICAgICBpZiAocmVwb05hbWUudG9Mb3dlckNhc2UoKS5pbmNsdWRlcygnZmxvd3N0YXRlJykpIHsKICAgICAgICBwcm9qZWN0ID0gJ0Zsb3dTdGF0ZSc7CiAgICAgICAgY29uZmlkZW5jZSA9IDAuOTsKICAgICAgfSBlbHNlIGlmIChyZXBvTmFtZS50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKCdjbGF1ZGVuJykpIHsKICAgICAgICBwcm9qZWN0ID0gJ0NsYXVkZU4nOwogICAgICAgIGNvbmZpZGVuY2UgPSAwLjk7CiAgICAgIH0gZWxzZSBpZiAocmVwb05hbWUpIHsKICAgICAgICAvLyBVc2UgdGhlIHJlcG9zaXRvcnkgbmFtZSBhcyB0aGUgcHJvamVjdAogICAgICAgIHByb2plY3QgPSByZXBvTmFtZTsKICAgICAgICBjb25maWRlbmNlID0gMC44OwogICAgICB9CiAgICAgIAogICAgICAvLyBEZXRlY3QgdGFzayBmcm9tIEdpdEh1YiBVUkwKICAgICAgZm9yIChjb25zdCBbcGF0dGVybiwgdGFza05hbWVdIG9mIE9iamVjdC5lbnRyaWVzKFRBU0tfUEFUVEVSTlNbJ2dpdGh1Yi5jb20nXSkpIHsKICAgICAgICBpZiAodXJsLnBhdGhuYW1lLmluY2x1ZGVzKHBhdHRlcm4pKSB7CiAgICAgICAgICB0YXNrID0gdGFza05hbWU7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CiAgCiAgLy8gQ2xhdWRlLmFpIGRldGVjdGlvbgogIGlmICh1cmwuaG9zdG5hbWUgPT09ICdjbGF1ZGUuYWknKSB7CiAgICAvLyBDaGVjayBjb252ZXJzYXRpb24gY29udGVudCBmcm9tIHRpdGxlCiAgICBjb25zdCBsb3dlclRpdGxlID0gdGFiLnRpdGxlLnRvTG93ZXJDYXNlKCk7CiAgICAKICAgIGZvciAoY29uc3QgW2tleXdvcmQsIHRhc2tOYW1lXSBvZiBPYmplY3QuZW50cmllcyhUQVNLX1BBVFRFUk5TWydjbGF1ZGUuYWknXSkpIHsKICAgICAgaWYgKGxvd2VyVGl0bGUuaW5jbHVkZXMoa2V5d29yZC50b0xvd2VyQ2FzZSgpKSkgewogICAgICAgIHRhc2sgPSB0YXNrTmFtZTsKICAgICAgICAKICAgICAgICAvLyBDaGVjayB3aGljaCBwcm9qZWN0IGJhc2VkIG9uIHBhdHRlcm5zCiAgICAgICAgZm9yIChjb25zdCBbcHJvak5hbWUsIHBhdHRlcm5zXSBvZiBPYmplY3QuZW50cmllcyhQUk9KRUNUX1BBVFRFUk5TKSkgewogICAgICAgICAgaWYgKHBhdHRlcm5zLnNvbWUocGF0dGVybiA9PiBwYXR0ZXJuLnRlc3QobG93ZXJUaXRsZSkpKSB7CiAgICAgICAgICAgIHByb2plY3QgPSBwcm9qTmFtZTsKICAgICAgICAgICAgY29uZmlkZW5jZSA9IDAuODsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgfQogIAogIC8vIElmIG5vIHNwZWNpZmljIHByb2plY3QgZGV0ZWN0ZWQsIGNoZWNrIHRpdGxlIHBhdHRlcm5zCiAgaWYgKCFwcm9qZWN0KSB7CiAgICBjb25zdCBjb21iaW5lZFRleHQgPSBgJHt0YWIudGl0bGV9ICR7dGFiLnVybH1gLnRvTG93ZXJDYXNlKCk7CiAgICAKICAgIGZvciAoY29uc3QgW3Byb2pOYW1lLCBwYXR0ZXJuc10gb2YgT2JqZWN0LmVudHJpZXMoUFJPSkVDVF9QQVRURVJOUykpIHsKICAgICAgY29uc3QgbWF0Y2hlcyA9IHBhdHRlcm5zLmZpbHRlcihwYXR0ZXJuID0+IHBhdHRlcm4udGVzdChjb21iaW5lZFRleHQpKS5sZW5ndGg7CiAgICAgIGlmIChtYXRjaGVzID4gMCkgewogICAgICAgIHByb2plY3QgPSBwcm9qTmFtZTsKICAgICAgICBjb25maWRlbmNlID0gTWF0aC5taW4oMC43LCBtYXRjaGVzICogMC4yKTsKICAgICAgICB0YXNrID0gYFdvcmtpbmcgb24gJHtwcm9qTmFtZX1gOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgfQogIAogIHJldHVybiB7IHByb2plY3QsIGNvbmZpZGVuY2UsIHRhc2sgfTsKfQoKLy8gTG9nIGFjdGl2aXR5IHRvIFN1cGFiYXNlCmFzeW5jIGZ1bmN0aW9uIGxvZ0N1cnJlbnRBY3Rpdml0eSgpIHsKICBpZiAoIWN1cnJlbnRDb250ZXh0LnByb2plY3QpIHJldHVybjsKICAKICBjaHJvbWUuc3RvcmFnZS5sb2NhbC5nZXQoWydzZXJ2aWNlS2V5JywgJ2VuYWJsZWQnXSwgYXN5bmMgKGRhdGEpID0+IHsKICAgIGlmICghZGF0YS5zZXJ2aWNlS2V5IHx8IGRhdGEuZW5hYmxlZCA9PT0gZmFsc2UpIHJldHVybjsKICAgIAogICAgdHJ5IHsKICAgICAgLy8gR2V0IGJyb3dzZXIgaW5mbyBmb3IgdW5pcXVlIG1hY2hpbmUgaWRlbnRpZmljYXRpb24KICAgICAgY29uc3QgYnJvd3NlckluZm8gPSBhd2FpdCBnZXRCcm93c2VySW5mbygpOwogICAgICBjb25zdCBtYWNoaW5lTmFtZSA9IGAke2Jyb3dzZXJJbmZvLmJyb3dzZXJ9IEV4dGVuc2lvbiAoJHticm93c2VySW5mby5vc30pYDsKICAgICAgCiAgICAgIC8vIEZpcnN0LCBlbnN1cmUgbWFjaGluZSBleGlzdHMgaW4gZGF0YWJhc2UKICAgICAgYXdhaXQgZW5zdXJlTWFjaGluZUV4aXN0cyhkYXRhLnNlcnZpY2VLZXksIG1hY2hpbmVOYW1lLCBicm93c2VySW5mbyk7CiAgICAgIAogICAgICBjb25zdCBhY3Rpdml0eURhdGEgPSB7CiAgICAgICAgdXNlcl9pZDogJ25lb190b2RhaycsCiAgICAgICAgYWN0aXZpdHlfdHlwZTogJ2Jyb3dzZXJfYWN0aXZpdHknLAogICAgICAgIGFjdGl2aXR5X2Rlc2NyaXB0aW9uOiBjdXJyZW50Q29udGV4dC50YXNrIHx8IGBXb3JraW5nIG9uICR7Y3VycmVudENvbnRleHQucHJvamVjdH1gLAogICAgICAgIHByb2plY3RfbmFtZTogY3VycmVudENvbnRleHQucHJvamVjdCwKICAgICAgICBjcmVhdGVkX2F0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksCiAgICAgICAgbWV0YWRhdGE6IHsKICAgICAgICAgIGNvbmZpZGVuY2U6IGN1cnJlbnRDb250ZXh0LmNvbmZpZGVuY2UsCiAgICAgICAgICBzb3VyY2U6ICdicm93c2VyX2V4dGVuc2lvbicsCiAgICAgICAgICBtYWNoaW5lOiBtYWNoaW5lTmFtZSwgIC8vIFVzZSBjb25zaXN0ZW50IG1hY2hpbmUgbmFtZQogICAgICAgICAgYnJvd3NlcjogYnJvd3NlckluZm8uYnJvd3NlciwKICAgICAgICAgIGJyb3dzZXJfdmVyc2lvbjogYnJvd3NlckluZm8udmVyc2lvbiwKICAgICAgICAgIG9zOiBicm93c2VySW5mby5vcwogICAgICAgIH0KICAgICAgfTsKICAgICAgCiAgICAgIC8vIFVzZSB0aGUgdW5pZmllZCBsb2dnaW5nIFJQQyBmdW5jdGlvbgogICAgICBjb25zdCB1bmlmaWVkUGF5bG9hZCA9IHsKICAgICAgICBwX3VzZXJfaWQ6ICduZW9fdG9kYWsnLAogICAgICAgIHBfcHJvamVjdF9uYW1lOiBjdXJyZW50Q29udGV4dC5wcm9qZWN0LAogICAgICAgIHBfYWN0aXZpdHlfdHlwZTogJ2Jyb3dzZXJfYWN0aXZpdHknLAogICAgICAgIHBfYWN0aXZpdHlfZGVzY3JpcHRpb246IGN1cnJlbnRDb250ZXh0LnRhc2sgfHwgYFdvcmtpbmcgb24gJHtjdXJyZW50Q29udGV4dC5wcm9qZWN0fWAsCiAgICAgICAgcF9tYWNoaW5lOiBtYWNoaW5lTmFtZSwKICAgICAgICBwX3NvdXJjZTogJ2Jyb3dzZXJfZXh0ZW5zaW9uJywKICAgICAgICBwX3Rvb2w6IGJyb3dzZXJJbmZvLmJyb3dzZXIsCiAgICAgICAgcF9pbXBvcnRhbmNlOiBjdXJyZW50Q29udGV4dC5jb25maWRlbmNlID4gMC44ID8gJ2hpZ2gnIDogJ25vcm1hbCcsCiAgICAgICAgcF9hZGRpdGlvbmFsX21ldGFkYXRhOiB7CiAgICAgICAgICBjb25maWRlbmNlOiBjdXJyZW50Q29udGV4dC5jb25maWRlbmNlLAogICAgICAgICAgYnJvd3NlcjogYnJvd3NlckluZm8uYnJvd3NlciwKICAgICAgICAgIGJyb3dzZXJfdmVyc2lvbjogYnJvd3NlckluZm8udmVyc2lvbiwKICAgICAgICAgIG9zOiBicm93c2VySW5mby5vcywKICAgICAgICAgIHVybDogY3VycmVudENvbnRleHQudXJsIHx8ICcnCiAgICAgICAgfQogICAgICB9OwogICAgICAKICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaChgJHtTVVBBQkFTRV9VUkx9L3Jlc3QvdjEvcnBjL2xvZ19hY3Rpdml0eV91bmlmaWVkYCwgewogICAgICAgIG1ldGhvZDogJ1BPU1QnLAogICAgICAgIGhlYWRlcnM6IHsKICAgICAgICAgICdhcGlrZXknOiBkYXRhLnNlcnZpY2VLZXksCiAgICAgICAgICAnQXV0aG9yaXphdGlvbic6IGBCZWFyZXIgJHtkYXRhLnNlcnZpY2VLZXl9YCwKICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicKICAgICAgICB9LAogICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHVuaWZpZWRQYXlsb2FkKQogICAgICB9KTsKICAgICAgCiAgICAgIGlmICghcmVzcG9uc2Uub2spIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEZhaWxlZCB0byBsb2cgYWN0aXZpdHk6ICR7YXdhaXQgcmVzcG9uc2UudGV4dCgpfWApOwogICAgICB9CiAgICAgIAogICAgICBjb25zb2xlLmxvZygnQWN0aXZpdHkgbG9nZ2VkIHN1Y2Nlc3NmdWxseSB2aWEgdW5pZmllZCBsb2dnZXInKTsKICAgICAgCiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBjb25zb2xlLmVycm9yKCdFcnJvciBsb2dnaW5nIGFjdGl2aXR5OicsIGVycm9yKTsKICAgIH0KICB9KTsKfQoKLy8gR2V0IGJyb3dzZXIgaW5mb3JtYXRpb24gZm9yIHVuaXF1ZSBtYWNoaW5lIGlkZW50aWZpY2F0aW9uCmFzeW5jIGZ1bmN0aW9uIGdldEJyb3dzZXJJbmZvKCkgewogIC8vIEdldCBicm93c2VyIG5hbWUgYW5kIHZlcnNpb24KICBjb25zdCB1c2VyQWdlbnQgPSBuYXZpZ2F0b3IudXNlckFnZW50OwogIGxldCBicm93c2VyID0gJ1Vua25vd24gQnJvd3Nlcic7CiAgbGV0IHZlcnNpb24gPSAnJzsKICAKICBpZiAodXNlckFnZW50LmluY2x1ZGVzKCdDaHJvbWUnKSkgewogICAgYnJvd3NlciA9ICdDaHJvbWUnOwogICAgdmVyc2lvbiA9IHVzZXJBZ2VudC5tYXRjaCgvQ2hyb21lXC8oWzAtOS5dKykvKT8uWzFdIHx8ICcnOwogIH0gZWxzZSBpZiAodXNlckFnZW50LmluY2x1ZGVzKCdGaXJlZm94JykpIHsKICAgIGJyb3dzZXIgPSAnRmlyZWZveCc7CiAgICB2ZXJzaW9uID0gdXNlckFnZW50Lm1hdGNoKC9GaXJlZm94XC8oWzAtOS5dKykvKT8uWzFdIHx8ICcnOwogIH0gZWxzZSBpZiAodXNlckFnZW50LmluY2x1ZGVzKCdTYWZhcmknKSkgewogICAgYnJvd3NlciA9ICdTYWZhcmknOwogICAgdmVyc2lvbiA9IHVzZXJBZ2VudC5tYXRjaCgvVmVyc2lvblwvKFswLTkuXSspLyk/LlsxXSB8fCAnJzsKICB9IGVsc2UgaWYgKHVzZXJBZ2VudC5pbmNsdWRlcygnRWRnZScpKSB7CiAgICBicm93c2VyID0gJ0VkZ2UnOwogICAgdmVyc2lvbiA9IHVzZXJBZ2VudC5tYXRjaCgvRWRnXC8oWzAtOS5dKykvKT8uWzFdIHx8ICcnOwogIH0KICAKICAvLyBHZXQgT1MKICBsZXQgb3MgPSAnVW5rbm93biBPUyc7CiAgaWYgKHVzZXJBZ2VudC5pbmNsdWRlcygnV2luZG93cycpKSBvcyA9ICdXaW5kb3dzJzsKICBlbHNlIGlmICh1c2VyQWdlbnQuaW5jbHVkZXMoJ01hYycpKSBvcyA9ICdtYWNPUyc7CiAgZWxzZSBpZiAodXNlckFnZW50LmluY2x1ZGVzKCdMaW51eCcpKSBvcyA9ICdMaW51eCc7CiAgZWxzZSBpZiAodXNlckFnZW50LmluY2x1ZGVzKCdBbmRyb2lkJykpIG9zID0gJ0FuZHJvaWQnOwogIGVsc2UgaWYgKHVzZXJBZ2VudC5pbmNsdWRlcygnaU9TJykpIG9zID0gJ2lPUyc7CiAgCiAgcmV0dXJuIHsgYnJvd3NlciwgdmVyc2lvbiwgb3MgfTsKfQoKLy8gRW5zdXJlIG1hY2hpbmUgZXhpc3RzIGluIGRhdGFiYXNlCmFzeW5jIGZ1bmN0aW9uIGVuc3VyZU1hY2hpbmVFeGlzdHMoc2VydmljZUtleSwgbWFjaGluZU5hbWUsIGJyb3dzZXJJbmZvKSB7CiAgdHJ5IHsKICAgIC8vIENoZWNrIGlmIG1hY2hpbmUgZXhpc3RzCiAgICBjb25zdCBjaGVja1Jlc3BvbnNlID0gYXdhaXQgZmV0Y2goCiAgICAgIGAke1NVUEFCQVNFX1VSTH0vcmVzdC92MS9jb250ZXh0X2VtYmVkZGluZ3M/dHlwZT1lcS5tYWNoaW5lJm5hbWU9ZXEuJHtlbmNvZGVVUklDb21wb25lbnQobWFjaGluZU5hbWUpfWAsCiAgICAgIHsKICAgICAgICBoZWFkZXJzOiB7CiAgICAgICAgICAnYXBpa2V5Jzogc2VydmljZUtleSwKICAgICAgICAgICdBdXRob3JpemF0aW9uJzogYEJlYXJlciAke3NlcnZpY2VLZXl9YAogICAgICAgIH0KICAgICAgfQogICAgKTsKICAgIAogICAgY29uc3QgbWFjaGluZXMgPSBhd2FpdCBjaGVja1Jlc3BvbnNlLmpzb24oKTsKICAgIAogICAgaWYgKCFtYWNoaW5lcyB8fCBtYWNoaW5lcy5sZW5ndGggPT09IDApIHsKICAgICAgLy8gQ3JlYXRlIG1hY2hpbmUgZW50cnkKICAgICAgY29uc3QgbWFjaGluZURhdGEgPSB7CiAgICAgICAgdHlwZTogJ21hY2hpbmUnLAogICAgICAgIG5hbWU6IG1hY2hpbmVOYW1lLAogICAgICAgIHBhcmVudF9uYW1lOiAnbmVvX3RvZGFrJywKICAgICAgICBtZXRhZGF0YTogewogICAgICAgICAgdXNlcl9pZDogJ25lb190b2RhaycsCiAgICAgICAgICBtYWNoaW5lX3R5cGU6ICdicm93c2VyX2V4dGVuc2lvbicsCiAgICAgICAgICBvczogYnJvd3NlckluZm8ub3MsCiAgICAgICAgICBicm93c2VyOiBicm93c2VySW5mby5icm93c2VyLAogICAgICAgICAgYnJvd3Nlcl92ZXJzaW9uOiBicm93c2VySW5mby52ZXJzaW9uLAogICAgICAgICAgbG9jYXRpb246ICdicm93c2VyJywKICAgICAgICAgIGljb246ICfwn4yQJywKICAgICAgICAgIGNyZWF0ZWRfYXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKQogICAgICAgIH0sCiAgICAgICAgZW1iZWRkaW5nOiBudWxsCiAgICAgIH07CiAgICAgIAogICAgICBhd2FpdCBmZXRjaChgJHtTVVBBQkFTRV9VUkx9L3Jlc3QvdjEvY29udGV4dF9lbWJlZGRpbmdzYCwgewogICAgICAgIG1ldGhvZDogJ1BPU1QnLAogICAgICAgIGhlYWRlcnM6IHsKICAgICAgICAgICdhcGlrZXknOiBzZXJ2aWNlS2V5LAogICAgICAgICAgJ0F1dGhvcml6YXRpb24nOiBgQmVhcmVyICR7c2VydmljZUtleX1gLAogICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJwogICAgICAgIH0sCiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkobWFjaGluZURhdGEpCiAgICAgIH0pOwogICAgICAKICAgICAgY29uc29sZS5sb2coJ0NyZWF0ZWQgbmV3IG1hY2hpbmUgZW50cnk6JywgbWFjaGluZU5hbWUpOwogICAgfQogIH0gY2F0Y2ggKGVycm9yKSB7CiAgICBjb25zb2xlLmVycm9yKCdFcnJvciBlbnN1cmluZyBtYWNoaW5lIGV4aXN0czonLCBlcnJvcik7CiAgfQp9CgovLyBVcGRhdGUgZXh0ZW5zaW9uIGJhZGdlCmZ1bmN0aW9uIHVwZGF0ZUJhZGdlKHByb2plY3QpIHsKICBpZiAoIXByb2plY3QpIHsKICAgIGNocm9tZS5hY3Rpb24uc2V0QmFkZ2VUZXh0KHsgdGV4dDogJycgfSk7CiAgICByZXR1cm47CiAgfQogIAogIC8vIFNob3cgYWJicmV2aWF0ZWQgcHJvamVjdCBuYW1lCiAgY29uc3QgYmFkZ2UgPSBwcm9qZWN0LnN1YnN0cmluZygwLCAyKS50b1VwcGVyQ2FzZSgpOwogIGNocm9tZS5hY3Rpb24uc2V0QmFkZ2VUZXh0KHsgdGV4dDogYmFkZ2UgfSk7CiAgY2hyb21lLmFjdGlvbi5zZXRCYWRnZUJhY2tncm91bmRDb2xvcih7IGNvbG9yOiAnIzIxOTZGMycgfSk7Cn0KCi8vIE1lc3NhZ2UgaGFuZGxlciBmb3IgcG9wdXAKY2hyb21lLnJ1bnRpbWUub25NZXNzYWdlLmFkZExpc3RlbmVyKChyZXF1ZXN0LCBzZW5kZXIsIHNlbmRSZXNwb25zZSkgPT4gewogIGlmIChyZXF1ZXN0LmFjdGlvbiA9PT0gJ2dldENvbnRleHQnKSB7CiAgICBzZW5kUmVzcG9uc2UoY3VycmVudENvbnRleHQpOwogIH0gZWxzZSBpZiAocmVxdWVzdC5hY3Rpb24gPT09ICdmb3JjZUNoZWNrJykgewogICAgY2hlY2tDdXJyZW50Q29udGV4dCgpLnRoZW4oKCkgPT4gewogICAgICBzZW5kUmVzcG9uc2UoY3VycmVudENvbnRleHQpOwogICAgfSk7CiAgICByZXR1cm4gdHJ1ZTsgLy8gS2VlcCBjaGFubmVsIG9wZW4gZm9yIGFzeW5jIHJlc3BvbnNlCiAgfSBlbHNlIGlmIChyZXF1ZXN0LmFjdGlvbiA9PT0gJ2xvZ0FjdGl2aXR5JykgewogICAgbG9nQ3VycmVudEFjdGl2aXR5KCkudGhlbigoKSA9PiB7CiAgICAgIHNlbmRSZXNwb25zZSh7IHN1Y2Nlc3M6IHRydWUgfSk7CiAgICB9KTsKICAgIHJldHVybiB0cnVlOwogIH0KfSk7
EOF

    echo "Creating popup.html..."
    cat << 'EOF' | base64 -d > "$EXTENSION_DIR/popup.html"
PCFET0NUWVBFIGh0bWw+CjxodG1sPgo8aGVhZD4KICAgIDxzdHlsZT4KICAgICAgICBib2R5IHsKICAgICAgICAgICAgd2lkdGg6IDMwMHB4OwogICAgICAgICAgICBwYWRkaW5nOiAxNXB4OwogICAgICAgICAgICBmb250LWZhbWlseTogLWFwcGxlLXN5c3RlbSwgQmxpbmtNYWNTeXN0ZW1Gb250LCAnU2Vnb2UgVUknLCBzYW5zLXNlcmlmOwogICAgICAgICAgICBtYXJnaW46IDA7CiAgICAgICAgfQogICAgICAgIGgyIHsKICAgICAgICAgICAgbWFyZ2luOiAwIDAgMTVweCAwOwogICAgICAgICAgICBjb2xvcjogIzIxOTZGMzsKICAgICAgICAgICAgZm9udC1zaXplOiAxOHB4OwogICAgICAgIH0KICAgICAgICAuc3RhdHVzIHsKICAgICAgICAgICAgcGFkZGluZzogMTVweDsKICAgICAgICAgICAgYmFja2dyb3VuZDogI2Y1ZjVmNTsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogOHB4OwogICAgICAgICAgICBtYXJnaW4tYm90dG9tOiAxNXB4OwogICAgICAgIH0KICAgICAgICAuc3RhdHVzLmFjdGl2ZSB7CiAgICAgICAgICAgIGJhY2tncm91bmQ6ICNlM2YyZmQ7CiAgICAgICAgICAgIGJvcmRlcjogMXB4IHNvbGlkICMyMTk2RjM7CiAgICAgICAgfQogICAgICAgIC5wcm9qZWN0LW5hbWUgewogICAgICAgICAgICBmb250LXNpemU6IDE2cHg7CiAgICAgICAgICAgIGZvbnQtd2VpZ2h0OiBib2xkOwogICAgICAgICAgICBtYXJnaW4tYm90dG9tOiA1cHg7CiAgICAgICAgfQogICAgICAgIC50YXNrIHsKICAgICAgICAgICAgZm9udC1zaXplOiAxNHB4OwogICAgICAgICAgICBjb2xvcjogIzY2NjsKICAgICAgICAgICAgbWFyZ2luLWJvdHRvbTogNXB4OwogICAgICAgIH0KICAgICAgICAuY29uZmlkZW5jZSB7CiAgICAgICAgICAgIGZvbnQtc2l6ZTogMTJweDsKICAgICAgICAgICAgY29sb3I6ICM5OTk7CiAgICAgICAgfQogICAgICAgIC5jb25maWRlbmNlLWJhciB7CiAgICAgICAgICAgIHdpZHRoOiAxMDAlOwogICAgICAgICAgICBoZWlnaHQ6IDRweDsKICAgICAgICAgICAgYmFja2dyb3VuZDogI2RkZDsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogMnB4OwogICAgICAgICAgICBtYXJnaW4tdG9wOiA1cHg7CiAgICAgICAgICAgIG92ZXJmbG93OiBoaWRkZW47CiAgICAgICAgfQogICAgICAgIC5jb25maWRlbmNlLWZpbGwgewogICAgICAgICAgICBoZWlnaHQ6IDEwMCU7CiAgICAgICAgICAgIGJhY2tncm91bmQ6ICMyMTk2RjM7CiAgICAgICAgICAgIHRyYW5zaXRpb246IHdpZHRoIDAuM3M7CiAgICAgICAgfQogICAgICAgIGJ1dHRvbiB7CiAgICAgICAgICAgIHdpZHRoOiAxMDAlOwogICAgICAgICAgICBwYWRkaW5nOiAxMHB4OwogICAgICAgICAgICBib3JkZXI6IG5vbmU7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDZweDsKICAgICAgICAgICAgYmFja2dyb3VuZDogIzIxOTZGMzsKICAgICAgICAgICAgY29sb3I6IHdoaXRlOwogICAgICAgICAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICAgICAgICAgIG1hcmdpbi1ib3R0b206IDEwcHg7CiAgICAgICAgfQogICAgICAgIGJ1dHRvbjpob3ZlciB7CiAgICAgICAgICAgIGJhY2tncm91bmQ6ICMxOTc2RDI7CiAgICAgICAgfQogICAgICAgIGJ1dHRvbjpkaXNhYmxlZCB7CiAgICAgICAgICAgIGJhY2tncm91bmQ6ICNjY2M7CiAgICAgICAgICAgIGN1cnNvcjogbm90LWFsbG93ZWQ7CiAgICAgICAgfQogICAgICAgIC5zZXR0aW5ncyB7CiAgICAgICAgICAgIG1hcmdpbi10b3A6IDE1cHg7CiAgICAgICAgICAgIHBhZGRpbmctdG9wOiAxNXB4OwogICAgICAgICAgICBib3JkZXItdG9wOiAxcHggc29saWQgI2RkZDsKICAgICAgICB9CiAgICAgICAgaW5wdXQgewogICAgICAgICAgICB3aWR0aDogMTAwJTsKICAgICAgICAgICAgcGFkZGluZzogOHB4OwogICAgICAgICAgICBib3JkZXI6IDFweCBzb2xpZCAjZGRkOwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiA0cHg7CiAgICAgICAgICAgIG1hcmdpbi1ib3R0b206IDEwcHg7CiAgICAgICAgICAgIGJveC1zaXppbmc6IGJvcmRlci1ib3g7CiAgICAgICAgfQogICAgICAgIC50b2dnbGUgewogICAgICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgICAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgICAgICAgICBqdXN0aWZ5LWNvbnRlbnQ6IHNwYWNlLWJldHdlZW47CiAgICAgICAgICAgIG1hcmdpbi1ib3R0b206IDEwcHg7CiAgICAgICAgfQogICAgICAgIC5zd2l0Y2ggewogICAgICAgICAgICBwb3NpdGlvbjogcmVsYXRpdmU7CiAgICAgICAgICAgIHdpZHRoOiA0MHB4OwogICAgICAgICAgICBoZWlnaHQ6IDIwcHg7CiAgICAgICAgfQogICAgICAgIC5zd2l0Y2ggaW5wdXQgewogICAgICAgICAgICBvcGFjaXR5OiAwOwogICAgICAgICAgICB3aWR0aDogMDsKICAgICAgICAgICAgaGVpZ2h0OiAwOwogICAgICAgIH0KICAgICAgICAuc2xpZGVyIHsKICAgICAgICAgICAgcG9zaXRpb246IGFic29sdXRlOwogICAgICAgICAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICAgICAgICAgIHRvcDogMDsKICAgICAgICAgICAgbGVmdDogMDsKICAgICAgICAgICAgcmlnaHQ6IDA7CiAgICAgICAgICAgIGJvdHRvbTogMDsKICAgICAgICAgICAgYmFja2dyb3VuZC1jb2xvcjogI2NjYzsKICAgICAgICAgICAgdHJhbnNpdGlvbjogLjRzOwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiAyMHB4OwogICAgICAgIH0KICAgICAgICAuc2xpZGVyOmJlZm9yZSB7CiAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgICAgICAgICAgY29udGVudDogIiI7CiAgICAgICAgICAgIGhlaWdodDogMTRweDsKICAgICAgICAgICAgd2lkdGg6IDE0cHg7CiAgICAgICAgICAgIGxlZnQ6IDNweDsKICAgICAgICAgICAgYm90dG9tOiAzcHg7CiAgICAgICAgICAgIGJhY2tncm91bmQtY29sb3I6IHdoaXRlOwogICAgICAgICAgICB0cmFuc2l0aW9uOiAuNHM7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgICAgICB9CiAgICAgICAgaW5wdXQ6Y2hlY2tlZCArIC5zbGlkZXIgewogICAgICAgICAgICBiYWNrZ3JvdW5kLWNvbG9yOiAjMjE5NkYzOwogICAgICAgIH0KICAgICAgICBpbnB1dDpjaGVja2VkICsgLnNsaWRlcjpiZWZvcmUgewogICAgICAgICAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoMjBweCk7CiAgICAgICAgfQogICAgICAgIC5uby1jb250ZXh0IHsKICAgICAgICAgICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgICAgICAgICBjb2xvcjogIzk5OTsKICAgICAgICAgICAgcGFkZGluZzogMjBweDsKICAgICAgICB9CiAgICA8L3N0eWxlPgo8L2hlYWQ+Cjxib2R5PgogICAgPGgyPvCfjIogRmxvd1N0YXRlIFRyYWNrZXI8L2gyPgogICAgCiAgICA8ZGl2IGlkPSJjb250ZXh0RGlzcGxheSIgY2xhc3M9InN0YXR1cyI+CiAgICAgICAgPGRpdiBjbGFzcz0ibm8tY29udGV4dCI+RGV0ZWN0aW5nIGNvbnRleHQuLi48L2Rpdj4KICAgIDwvZGl2PgogICAgCiAgICA8YnV0dG9uIGlkPSJyZWZyZXNoQnRuIj5SZWZyZXNoIENvbnRleHQ8L2J1dHRvbj4KICAgIDxidXR0b24gaWQ9ImxvZ0J0biI+TG9nIEFjdGl2aXR5IE5vdzwvYnV0dG9uPgogICAgCiAgICA8ZGl2IGNsYXNzPSJzZXR0aW5ncyI+CiAgICAgICAgPGRpdiBjbGFzcz0idG9nZ2xlIj4KICAgICAgICAgICAgPHNwYW4+RW5hYmxlIFRyYWNraW5nPC9zcGFuPgogICAgICAgICAgICA8bGFiZWwgY2xhc3M9InN3aXRjaCI+CiAgICAgICAgICAgICAgICA8aW5wdXQgdHlwZT0iY2hlY2tib3giIGlkPSJlbmFibGVUb2dnbGUiIGNoZWNrZWQ+CiAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0ic2xpZGVyIj48L3NwYW4+CiAgICAgICAgICAgIDwvbGFiZWw+CiAgICAgICAgPC9kaXY+CiAgICAgICAgCiAgICAgICAgPGlucHV0IHR5cGU9InBhc3N3b3JkIiBpZD0ic2VydmljZUtleSIgcGxhY2Vob2xkZXI9IlN1cGFiYXNlIFNlcnZpY2UgS2V5Ij4KICAgICAgICA8YnV0dG9uIGlkPSJzYXZlQnRuIj5TYXZlIFNldHRpbmdzPC9idXR0b24+CiAgICA8L2Rpdj4KICAgIAogICAgPHNjcmlwdCBzcmM9InBvcHVwLmpzIj48L3NjcmlwdD4KPC9ib2R5Pgo8L2h0bWw+
EOF

    echo "Creating popup.js..."
    cat << 'EOF' | base64 -d > "$EXTENSION_DIR/popup.js"
Ly8gRmxvd1N0YXRlIEJyb3dzZXIgRXh0ZW5zaW9uIC0gUG9wdXAgU2NyaXB0Cgpkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdET01Db250ZW50TG9hZGVkJywgYXN5bmMgKCkgPT4gewogICAgLy8gTG9hZCBzYXZlZCBzZXR0aW5ncwogICAgY29uc3Qgc2V0dGluZ3MgPSBhd2FpdCBjaHJvbWUuc3RvcmFnZS5sb2NhbC5nZXQoWydzZXJ2aWNlS2V5JywgJ2VuYWJsZWQnXSk7CiAgICAKICAgIGlmIChzZXR0aW5ncy5zZXJ2aWNlS2V5KSB7CiAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NlcnZpY2VLZXknKS52YWx1ZSA9IHNldHRpbmdzLnNlcnZpY2VLZXk7CiAgICB9CiAgICAKICAgIGlmIChzZXR0aW5ncy5lbmFibGVkICE9PSB1bmRlZmluZWQpIHsKICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZW5hYmxlVG9nZ2xlJykuY2hlY2tlZCA9IHNldHRpbmdzLmVuYWJsZWQ7CiAgICB9CiAgICAKICAgIC8vIEdldCBjdXJyZW50IGNvbnRleHQKICAgIHVwZGF0ZUNvbnRleHREaXNwbGF5KCk7CiAgICAKICAgIC8vIEJ1dHRvbiBoYW5kbGVycwogICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3JlZnJlc2hCdG4nKS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGFzeW5jICgpID0+IHsKICAgICAgICBjb25zdCBidG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmVmcmVzaEJ0bicpOwogICAgICAgIGJ0bi5kaXNhYmxlZCA9IHRydWU7CiAgICAgICAgYnRuLnRleHRDb250ZW50ID0gJ1JlZnJlc2hpbmcuLi4nOwogICAgICAgIAogICAgICAgIGNocm9tZS5ydW50aW1lLnNlbmRNZXNzYWdlKHsgYWN0aW9uOiAnZm9yY2VDaGVjaycgfSwgKHJlc3BvbnNlKSA9PiB7CiAgICAgICAgICAgIHVwZGF0ZUNvbnRleHREaXNwbGF5KCk7CiAgICAgICAgICAgIGJ0bi5kaXNhYmxlZCA9IGZhbHNlOwogICAgICAgICAgICBidG4udGV4dENvbnRlbnQgPSAnUmVmcmVzaCBDb250ZXh0JzsKICAgICAgICB9KTsKICAgIH0pOwogICAgCiAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbG9nQnRuJykuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBhc3luYyAoKSA9PiB7CiAgICAgICAgY29uc3QgYnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2xvZ0J0bicpOwogICAgICAgIGJ0bi5kaXNhYmxlZCA9IHRydWU7CiAgICAgICAgYnRuLnRleHRDb250ZW50ID0gJ0xvZ2dpbmcuLi4nOwogICAgICAgIAogICAgICAgIGNocm9tZS5ydW50aW1lLnNlbmRNZXNzYWdlKHsgYWN0aW9uOiAnbG9nQWN0aXZpdHknIH0sIChyZXNwb25zZSkgPT4gewogICAgICAgICAgICBidG4uZGlzYWJsZWQgPSBmYWxzZTsKICAgICAgICAgICAgYnRuLnRleHRDb250ZW50ID0gJ0xvZyBBY3Rpdml0eSBOb3cnOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHJlc3BvbnNlICYmIHJlc3BvbnNlLnN1Y2Nlc3MpIHsKICAgICAgICAgICAgICAgIHNob3dTdGF0dXMoJ0FjdGl2aXR5IGxvZ2dlZCEnKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgfSk7CiAgICAKICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzYXZlQnRuJykuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBhc3luYyAoKSA9PiB7CiAgICAgICAgY29uc3Qgc2VydmljZUtleSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzZXJ2aWNlS2V5JykudmFsdWU7CiAgICAgICAgY29uc3QgZW5hYmxlZCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdlbmFibGVUb2dnbGUnKS5jaGVja2VkOwogICAgICAgIAogICAgICAgIGF3YWl0IGNocm9tZS5zdG9yYWdlLmxvY2FsLnNldCh7IHNlcnZpY2VLZXksIGVuYWJsZWQgfSk7CiAgICAgICAgc2hvd1N0YXR1cygnU2V0dGluZ3Mgc2F2ZWQhJyk7CiAgICB9KTsKICAgIAogICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2VuYWJsZVRvZ2dsZScpLmFkZEV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsIGFzeW5jIChlKSA9PiB7CiAgICAgICAgYXdhaXQgY2hyb21lLnN0b3JhZ2UubG9jYWwuc2V0KHsgZW5hYmxlZDogZS50YXJnZXQuY2hlY2tlZCB9KTsKICAgIH0pOwp9KTsKCmZ1bmN0aW9uIHVwZGF0ZUNvbnRleHREaXNwbGF5KCkgewogICAgY2hyb21lLnJ1bnRpbWUuc2VuZE1lc3NhZ2UoeyBhY3Rpb246ICdnZXRDb250ZXh0JyB9LCAoY29udGV4dCkgPT4gewogICAgICAgIGNvbnN0IGRpc3BsYXkgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY29udGV4dERpc3BsYXknKTsKICAgICAgICAKICAgICAgICBpZiAoIWNvbnRleHQgfHwgIWNvbnRleHQucHJvamVjdCkgewogICAgICAgICAgICBkaXNwbGF5LmlubmVySFRNTCA9ICc8ZGl2IGNsYXNzPSJuby1jb250ZXh0Ij5ObyBhY3RpdmUgcHJvamVjdCBkZXRlY3RlZDwvZGl2Pic7CiAgICAgICAgICAgIGRpc3BsYXkuY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgZGlzcGxheS5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICBkaXNwbGF5LmlubmVySFRNTCA9IGAKICAgICAgICAgICAgPGRpdiBjbGFzcz0icHJvamVjdC1uYW1lIj4ke2NvbnRleHQucHJvamVjdH08L2Rpdj4KICAgICAgICAgICAgPGRpdiBjbGFzcz0idGFzayI+JHtjb250ZXh0LnRhc2sgfHwgJ0dlbmVyYWwgd29yayd9PC9kaXY+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9ImNvbmZpZGVuY2UiPgogICAgICAgICAgICAgICAgQ29uZmlkZW5jZTogJHtNYXRoLnJvdW5kKGNvbnRleHQuY29uZmlkZW5jZSAqIDEwMCl9JQogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBjbGFzcz0iY29uZmlkZW5jZS1iYXIiPgogICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iY29uZmlkZW5jZS1maWxsIiBzdHlsZT0id2lkdGg6ICR7Y29udGV4dC5jb25maWRlbmNlICogMTAwfSUiPjwvZGl2PgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICBgOwogICAgfSk7Cn0KCmZ1bmN0aW9uIHNob3dTdGF0dXMobWVzc2FnZSkgewogICAgY29uc3QgYnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NhdmVCdG4nKTsKICAgIGNvbnN0IG9yaWdpbmFsVGV4dCA9IGJ0bi50ZXh0Q29udGVudDsKICAgIGJ0bi50ZXh0Q29udGVudCA9IG1lc3NhZ2U7CiAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICBidG4udGV4dENvbnRlbnQgPSBvcmlnaW5hbFRleHQ7CiAgICB9LCAyMDAwKTsKfQ==
EOF

    echo "Creating icon16.png..."
    cat << 'EOF' | base64 -d > "$EXTENSION_DIR/icon16.png"
iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAA7AAAAOwBeShxvQAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAABPSURBVDiN7Y4xCgAwCAN3/v+zHRxELYKD0DkItyQEQETkRkb1AaBqAS5nZ/cFmJkPgKoWYGcPzOwTwN0LsLNb/w7M7AWoun0Cd/8EZvaSDR4hKQ9nQ4ujAAAAAElFTkSuQmCC
EOF

    echo "Creating icon48.png..."
    cat << 'EOF' | base64 -d > "$EXTENSION_DIR/icon48.png"
iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAA7AAAAOwBeShxvQAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAABwSURBVGiB7dihDcAwDETRl2XJMmQZsgyZJcswTJcFSiGDolCQ/S+5Vc4nOTkiIs6mqiZ2Zna8SxERd5IkSZKkf1TV5HneAfQk7T1PE5GZ2YGYGRFBP6mqiTnndQBXkvae0TSYmR2I3gfozOwXJEl64gGhiyUhjV/PCQAAAABJRU5ErkJggg==
EOF

    echo "Creating icon128.png..."
    cat << 'EOF' | base64 -d > "$EXTENSION_DIR/icon128.png"
iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAA7AAAAOwBeShxvQAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAACXSURBVHic7duxDYAwDETRh2UsQxYiy5BlmC4LQAEUKATZeq9y5fycZEeSpL+oqsnd3V1EvCfOzKoGZmZHZGZExPshqmqCu7u7iIj3xJlZ1cDM7IjMjKn5PoADMjM6MDPb+wCOSLsPoKqmmJlddwAzs6qBu7u7iIj3xJlZ1cDM7IjMjIh4T5yaVQ3MzI7I9wFI0vAeEUUzCJdnGBsAAAAASUVORK5CYII=
EOF

    echo "Files extracted successfully"
}


extract_files

# Instructions
echo
echo "==================================="
echo "INSTALLATION INSTRUCTIONS:"
echo "==================================="
echo "1. Opening Chrome to extensions page..."
echo "2. Enable 'Developer mode' (toggle in top right)"
echo "3. Click 'Load unpacked'"
echo "4. Navigate to: $EXTENSION_DIR"
echo "5. Click 'Select'"
echo
echo "After installation:"
echo "- Click the FlowState icon in toolbar"
echo "- Enter your service key"
echo "- Enable tracking"
echo "==================================="
echo

# Open Chrome extensions page
open -a "Google Chrome" "chrome://extensions/" 2>/dev/null || \
open -a "Google Chrome" --args --new-window "chrome://extensions/" 2>/dev/null

# Also try other browsers
open -a "Microsoft Edge" "edge://extensions/" 2>/dev/null &
open -a "Brave Browser" "brave://extensions/" 2>/dev/null &

echo "Extension files installed to: $EXTENSION_DIR"
echo "Press Enter to exit..."
read