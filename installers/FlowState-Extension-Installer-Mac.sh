#!/bin/bash

echo "==================================="
echo "FlowState Browser Extension Installer"
echo "==================================="
echo

# Set extension directory
EXTENSION_DIR="$HOME/Library/Application Support/FlowState/browser-extension"

# Create directory
echo "Creating extension directory..."
mkdir -p "$EXTENSION_DIR"

# Extract extension files (embedded in script)
echo "Extracting extension files..."
extract_files() {
    echo "Creating manifest.json..."
    cat << 'EOF' | base64 -d > "$EXTENSION_DIR/manifest.json"
ewogICJtYW5pZmVzdF92ZXJzaW9uIjogMywKICAibmFtZSI6ICJGbG93U3RhdGUgQ29udGV4dCBUcmFja2VyIiwKICAidmVyc2lvbiI6ICIxLjAuMiIsCiAgImRlc2NyaXB0aW9uIjogIkF1dG9tYXRpY2FsbHkgdHJhY2tzIHlvdXIgY3VycmVudCBwcm9qZWN0IGNvbnRleHQgYmFzZWQgb24gYnJvd3NlciBhY3Rpdml0eSIsCiAgInBlcm1pc3Npb25zIjogWwogICAgInRhYnMiLAogICAgInN0b3JhZ2UiLAogICAgImFsYXJtcyIKICBdLAogICJob3N0X3Blcm1pc3Npb25zIjogWwogICAgImh0dHBzOi8vZ2l0aHViLmNvbS8qIiwKICAgICJodHRwczovL2NsYXVkZS5haS8qIiwKICAgICJodHRwOi8vbG9jYWxob3N0LyoiLAogICAgImh0dHBzOi8vKi5zdXBhYmFzZS5jby8qIgogIF0sCiAgImJhY2tncm91bmQiOiB7CiAgICAic2VydmljZV93b3JrZXIiOiAiYmFja2dyb3VuZC5qcyIKICB9LAogICJhY3Rpb24iOiB7CiAgICAiZGVmYXVsdF9wb3B1cCI6ICJwb3B1cC5odG1sIiwKICAgICJkZWZhdWx0X2ljb24iOiB7CiAgICAgICIxNiI6ICJpY29uMTYucG5nIiwKICAgICAgIjQ4IjogImljb240OC5wbmciLAogICAgICAiMTI4IjogImljb24xMjgucG5nIgogICAgfQogIH0sCiAgImljb25zIjogewogICAgIjE2IjogImljb24xNi5wbmciLAogICAgIjQ4IjogImljb240OC5wbmciLAogICAgIjEyOCI6ICJpY29uMTI4LnBuZyIKICB9Cn0=
EOF

    echo "Creating background.js..."
    cat << 'EOF' | base64 -d > "$EXTENSION_DIR/background.js"
Ly8gRmxvd1N0YXRlIEJyb3dzZXIgRXh0ZW5zaW9uIC0gQmFja2dyb3VuZCBTZXJ2aWNlIFdvcmtlcgoKY29uc3QgU1VQQUJBU0VfVVJMID0gJ2h0dHBzOi8vdXphbWFteW1memhlbHZrd3B2Z3Quc3VwYWJhc2UuY28nOwpjb25zdCBDSEVDS19JTlRFUlZBTCA9IDMwMDAwOyAvLyBDaGVjayBldmVyeSAzMCBzZWNvbmRzCmNvbnN0IEFDVElWSVRZX0lOVEVSVkFMID0gMzAwMDAwOyAvLyBMb2cgYWN0aXZpdHkgZXZlcnkgNSBtaW51dGVzCgpsZXQgbGFzdEFjdGl2aXR5ID0ge307CmxldCBjdXJyZW50Q29udGV4dCA9IHsKICBwcm9qZWN0OiBudWxsLAogIHRhc2s6IG51bGwsCiAgY29uZmlkZW5jZTogMAp9OwoKLy8gUHJvamVjdCBkZXRlY3Rpb24gcGF0dGVybnMKY29uc3QgUFJPSkVDVF9QQVRURVJOUyA9IHsKICAnRmxvd1N0YXRlJzogWwogICAgL2Zsb3dzdGF0ZS9pLAogICAgL2Zsb3ctc3RhdGUvaSwKICAgIC90b2Rhay1haS9pLAogICAgL2VtYmVkZGluZ3MvaSwKICAgIC9jb250ZXh0IGRldGVjdGlvbi9pCiAgXSwKICAnQ2xhdWRlTic6IFsKICAgIC9jbGF1ZGVuL2ksCiAgICAvY2xhdWRlXC5haS4qZGFzaGJvYXJkL2ksCiAgICAvYW50aHJvcGljLipkYXNoYm9hcmQvaQogIF0sCiAgLy8gQXV0by1kZXRlY3QgYW55IEdpdEh1YiBwcm9qZWN0CiAgJ0dpdEh1Yic6IFsKICAgIC9naXRodWJcLmNvbS9pCiAgXQp9OwoKLy8gVGFzayBkZXRlY3Rpb24gcGF0dGVybnMgYmFzZWQgb24gVVJMcyBhbmQgdGl0bGVzCmNvbnN0IFRBU0tfUEFUVEVSTlMgPSB7CiAgJ2dpdGh1Yi5jb20nOiB7CiAgICAnL2lzc3Vlcy8nOiAnTWFuYWdpbmcgaXNzdWVzJywKICAgICcvcHVsbC8nOiAnUmV2aWV3aW5nIHB1bGwgcmVxdWVzdHMnLAogICAgJy9jb21taXQvJzogJ1Jldmlld2luZyBjb21taXRzJywKICAgICcvdHJlZS8nOiAnQnJvd3NpbmcgY29kZScsCiAgICAnL2Jsb2IvJzogJ1JlYWRpbmcgY29kZScsCiAgICAnL2VkaXQvJzogJ0VkaXRpbmcgY29kZScsCiAgICAnL25ldy8nOiAnQ3JlYXRpbmcgbmV3IGZpbGUnCiAgfSwKICAnY2xhdWRlLmFpJzogewogICAgJ0Zsb3dTdGF0ZSc6ICdBSSBjb252ZXJzYXRpb24gYWJvdXQgRmxvd1N0YXRlJywKICAgICdlbWJlZGRpbmcnOiAnV29ya2luZyBvbiBlbWJlZGRpbmdzJywKICAgICdjb250ZXh0JzogJ0ltcHJvdmluZyBjb250ZXh0IGRldGVjdGlvbicsCiAgICAndHJhY2tpbmcnOiAnSW1wbGVtZW50aW5nIGFjdGl2aXR5IHRyYWNraW5nJwogIH0sCiAgJ2xvY2FsaG9zdCc6IHsKICAgICc6MzAwMCc6ICdMb2NhbCBkZXZlbG9wbWVudCcsCiAgICAnOjgwODAnOiAnVGVzdGluZyBhcHBsaWNhdGlvbicsCiAgICAnOjUxNzMnOiAnVml0ZSBkZXZlbG9wbWVudCcKICB9Cn07CgovLyBJbml0aWFsaXplIGV4dGVuc2lvbgpjaHJvbWUucnVudGltZS5vbkluc3RhbGxlZC5hZGRMaXN0ZW5lcigoKSA9PiB7CiAgY29uc29sZS5sb2coJ0Zsb3dTdGF0ZSBDb250ZXh0IFRyYWNrZXIgaW5zdGFsbGVkJyk7CiAgCiAgLy8gU2V0IHVwIGFsYXJtcyBmb3IgcGVyaW9kaWMgY2hlY2tzCiAgY2hyb21lLmFsYXJtcy5jcmVhdGUoJ2NoZWNrQ29udGV4dCcsIHsgcGVyaW9kSW5NaW51dGVzOiAwLjUgfSk7CiAgY2hyb21lLmFsYXJtcy5jcmVhdGUoJ2xvZ0FjdGl2aXR5JywgeyBwZXJpb2RJbk1pbnV0ZXM6IDUgfSk7CiAgCiAgLy8gTG9hZCBzYXZlZCBjb25maWd1cmF0aW9uCiAgY2hyb21lLnN0b3JhZ2UubG9jYWwuZ2V0KFsnc2VydmljZUtleScsICdlbmFibGVkJ10sIChkYXRhKSA9PiB7CiAgICBpZiAoIWRhdGEuc2VydmljZUtleSkgewogICAgICBjb25zb2xlLmxvZygnU2VydmljZSBrZXkgbm90IGNvbmZpZ3VyZWQnKTsKICAgIH0KICB9KTsKICAKICAvLyBJbml0aWFsIGNvbnRleHQgY2hlY2sKICBjaGVja0N1cnJlbnRDb250ZXh0KCk7Cn0pOwoKLy8gTGlzdGVuIGZvciBhbGFybSBldmVudHMKY2hyb21lLmFsYXJtcy5vbkFsYXJtLmFkZExpc3RlbmVyKChhbGFybSkgPT4gewogIGlmIChhbGFybS5uYW1lID09PSAnY2hlY2tDb250ZXh0JykgewogICAgY2hlY2tDdXJyZW50Q29udGV4dCgpOwogIH0gZWxzZSBpZiAoYWxhcm0ubmFtZSA9PT0gJ2xvZ0FjdGl2aXR5JykgewogICAgbG9nQ3VycmVudEFjdGl2aXR5KCk7CiAgfQp9KTsKCi8vIExpc3RlbiBmb3IgdGFiIHVwZGF0ZXMKY2hyb21lLnRhYnMub25BY3RpdmF0ZWQuYWRkTGlzdGVuZXIoKCkgPT4gewogIGNoZWNrQ3VycmVudENvbnRleHQoKTsKfSk7CgpjaHJvbWUudGFicy5vblVwZGF0ZWQuYWRkTGlzdGVuZXIoKHRhYklkLCBjaGFuZ2VJbmZvLCB0YWIpID0+IHsKICBpZiAoY2hhbmdlSW5mby5zdGF0dXMgPT09ICdjb21wbGV0ZScpIHsKICAgIGNoZWNrQ3VycmVudENvbnRleHQoKTsKICB9Cn0pOwoKLy8gTWFpbiBjb250ZXh0IGRldGVjdGlvbiBmdW5jdGlvbgphc3luYyBmdW5jdGlvbiBjaGVja0N1cnJlbnRDb250ZXh0KCkgewogIHRyeSB7CiAgICAvLyBHZXQgYWxsIHRhYnMKICAgIGNvbnN0IHRhYnMgPSBhd2FpdCBjaHJvbWUudGFicy5xdWVyeSh7fSk7CiAgICAKICAgIC8vIEFuYWx5emUgYWN0aXZlIHRhYnMKICAgIGNvbnN0IGFjdGl2ZVRhYiA9IHRhYnMuZmluZCh0YWIgPT4gdGFiLmFjdGl2ZSk7CiAgICBjb25zdCByZWNlbnRUYWJzID0gdGFicy5maWx0ZXIodGFiID0+IHRhYi5sYXN0QWNjZXNzZWQgJiYgCiAgICAgIChEYXRlLm5vdygpIC0gdGFiLmxhc3RBY2Nlc3NlZCA8IDYwMDAwMCkpOyAvLyBMYXN0IDEwIG1pbnV0ZXMKICAgIAogICAgLy8gRGV0ZWN0IHByb2plY3QgZnJvbSB0YWJzCiAgICBsZXQgZGV0ZWN0ZWRQcm9qZWN0ID0gbnVsbDsKICAgIGxldCBjb25maWRlbmNlID0gMDsKICAgIGxldCB0YXNrRGVzY3JpcHRpb24gPSAnJzsKICAgIAogICAgLy8gQ2hlY2sgYWN0aXZlIHRhYiBmaXJzdAogICAgaWYgKGFjdGl2ZVRhYikgewogICAgICBjb25zdCBkZXRlY3Rpb24gPSBkZXRlY3RQcm9qZWN0RnJvbVRhYihhY3RpdmVUYWIpOwogICAgICBpZiAoZGV0ZWN0aW9uLnByb2plY3QpIHsKICAgICAgICBkZXRlY3RlZFByb2plY3QgPSBkZXRlY3Rpb24ucHJvamVjdDsKICAgICAgICBjb25maWRlbmNlID0gZGV0ZWN0aW9uLmNvbmZpZGVuY2U7CiAgICAgICAgdGFza0Rlc2NyaXB0aW9uID0gZGV0ZWN0aW9uLnRhc2s7CiAgICAgIH0KICAgIH0KICAgIAogICAgLy8gQ2hlY2sgcmVjZW50IHRhYnMgaWYgbm8gc3Ryb25nIG1hdGNoCiAgICBpZiAoY29uZmlkZW5jZSA8IDAuOCkgewogICAgICBmb3IgKGNvbnN0IHRhYiBvZiByZWNlbnRUYWJzKSB7CiAgICAgICAgY29uc3QgZGV0ZWN0aW9uID0gZGV0ZWN0UHJvamVjdEZyb21UYWIodGFiKTsKICAgICAgICBpZiAoZGV0ZWN0aW9uLmNvbmZpZGVuY2UgPiBjb25maWRlbmNlKSB7CiAgICAgICAgICBkZXRlY3RlZFByb2plY3QgPSBkZXRlY3Rpb24ucHJvamVjdDsKICAgICAgICAgIGNvbmZpZGVuY2UgPSBkZXRlY3Rpb24uY29uZmlkZW5jZTsKICAgICAgICAgIHRhc2tEZXNjcmlwdGlvbiA9IGRldGVjdGlvbi50YXNrOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgCiAgICAvLyBVcGRhdGUgY29udGV4dCBpZiBjaGFuZ2VkIHNpZ25pZmljYW50bHkKICAgIGlmIChkZXRlY3RlZFByb2plY3QgJiYgKAogICAgICBkZXRlY3RlZFByb2plY3QgIT09IGN1cnJlbnRDb250ZXh0LnByb2plY3QgfHwKICAgICAgTWF0aC5hYnMoY29uZmlkZW5jZSAtIGN1cnJlbnRDb250ZXh0LmNvbmZpZGVuY2UpID4gMC4yCiAgICApKSB7CiAgICAgIGN1cnJlbnRDb250ZXh0ID0gewogICAgICAgIHByb2plY3Q6IGRldGVjdGVkUHJvamVjdCwKICAgICAgICB0YXNrOiB0YXNrRGVzY3JpcHRpb24sCiAgICAgICAgY29uZmlkZW5jZTogY29uZmlkZW5jZSwKICAgICAgICB1cmw6IGFjdGl2ZVRhYiA/IGFjdGl2ZVRhYi51cmwgOiAnJywKICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKQogICAgICB9OwogICAgICAKICAgICAgLy8gVXBkYXRlIGJhZGdlIHRvIHNob3cgY3VycmVudCBwcm9qZWN0CiAgICAgIHVwZGF0ZUJhZGdlKGRldGVjdGVkUHJvamVjdCk7CiAgICAgIAogICAgICAvLyBTdG9yZSBpbiBsb2NhbCBzdG9yYWdlCiAgICAgIGNocm9tZS5zdG9yYWdlLmxvY2FsLnNldCh7IGN1cnJlbnRDb250ZXh0IH0pOwogICAgfQogICAgCiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGNoZWNraW5nIGNvbnRleHQ6JywgZXJyb3IpOwogIH0KfQoKLy8gRGV0ZWN0IHByb2plY3QgZnJvbSBhIHNpbmdsZSB0YWIKZnVuY3Rpb24gZGV0ZWN0UHJvamVjdEZyb21UYWIodGFiKSB7CiAgaWYgKCF0YWIudXJsIHx8ICF0YWIudGl0bGUpIHsKICAgIHJldHVybiB7IHByb2plY3Q6IG51bGwsIGNvbmZpZGVuY2U6IDAsIHRhc2s6ICcnIH07CiAgfQogIAogIGxldCBwcm9qZWN0ID0gbnVsbDsKICBsZXQgY29uZmlkZW5jZSA9IDA7CiAgbGV0IHRhc2sgPSAnJzsKICAKICAvLyBDaGVjayBVUkwgcGF0dGVybnMKICBjb25zdCB1cmwgPSBuZXcgVVJMKHRhYi51cmwpOwogIAogIC8vIEdpdEh1YiByZXBvc2l0b3J5IGRldGVjdGlvbgogIGlmICh1cmwuaG9zdG5hbWUgPT09ICdnaXRodWIuY29tJykgewogICAgY29uc3QgcGF0aFBhcnRzID0gdXJsLnBhdGhuYW1lLnNwbGl0KCcvJyk7CiAgICBpZiAocGF0aFBhcnRzLmxlbmd0aCA+PSAzKSB7CiAgICAgIGNvbnN0IHJlcG9OYW1lID0gcGF0aFBhcnRzWzJdOwogICAgICAKICAgICAgLy8gQ2hlY2sgaWYgaXQncyBhIGtub3duIHByb2plY3QKICAgICAgaWYgKHJlcG9OYW1lLnRvTG93ZXJDYXNlKCkgPT09ICdmbG93c3RhdGUtYWknKSB7CiAgICAgICAgcHJvamVjdCA9ICdGbG93U3RhdGUgQUknOwogICAgICAgIGNvbmZpZGVuY2UgPSAwLjk1OwogICAgICB9IGVsc2UgaWYgKHJlcG9OYW1lLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoJ2Zsb3dzdGF0ZScpKSB7CiAgICAgICAgcHJvamVjdCA9ICdGbG93U3RhdGUnOwogICAgICAgIGNvbmZpZGVuY2UgPSAwLjk7CiAgICAgIH0gZWxzZSBpZiAocmVwb05hbWUudG9Mb3dlckNhc2UoKS5pbmNsdWRlcygnY2xhdWRlbicpKSB7CiAgICAgICAgcHJvamVjdCA9ICdDbGF1ZGVOJzsKICAgICAgICBjb25maWRlbmNlID0gMC45OwogICAgICB9IGVsc2UgaWYgKHJlcG9OYW1lKSB7CiAgICAgICAgLy8gVXNlIHRoZSByZXBvc2l0b3J5IG5hbWUgYXMgdGhlIHByb2plY3QKICAgICAgICBwcm9qZWN0ID0gcmVwb05hbWU7CiAgICAgICAgY29uZmlkZW5jZSA9IDAuODsKICAgICAgfQogICAgICAKICAgICAgLy8gRGV0ZWN0IHRhc2sgZnJvbSBHaXRIdWIgVVJMCiAgICAgIGZvciAoY29uc3QgW3BhdHRlcm4sIHRhc2tOYW1lXSBvZiBPYmplY3QuZW50cmllcyhUQVNLX1BBVFRFUk5TWydnaXRodWIuY29tJ10pKSB7CiAgICAgICAgaWYgKHVybC5wYXRobmFtZS5pbmNsdWRlcyhwYXR0ZXJuKSkgewogICAgICAgICAgdGFzayA9IHRhc2tOYW1lOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQogIAogIC8vIENsYXVkZS5haSBkZXRlY3Rpb24KICBpZiAodXJsLmhvc3RuYW1lID09PSAnY2xhdWRlLmFpJykgewogICAgLy8gQ2hlY2sgY29udmVyc2F0aW9uIGNvbnRlbnQgZnJvbSB0aXRsZQogICAgY29uc3QgbG93ZXJUaXRsZSA9IHRhYi50aXRsZS50b0xvd2VyQ2FzZSgpOwogICAgCiAgICBmb3IgKGNvbnN0IFtrZXl3b3JkLCB0YXNrTmFtZV0gb2YgT2JqZWN0LmVudHJpZXMoVEFTS19QQVRURVJOU1snY2xhdWRlLmFpJ10pKSB7CiAgICAgIGlmIChsb3dlclRpdGxlLmluY2x1ZGVzKGtleXdvcmQudG9Mb3dlckNhc2UoKSkpIHsKICAgICAgICB0YXNrID0gdGFza05hbWU7CiAgICAgICAgCiAgICAgICAgLy8gQ2hlY2sgd2hpY2ggcHJvamVjdCBiYXNlZCBvbiBwYXR0ZXJucwogICAgICAgIGZvciAoY29uc3QgW3Byb2pOYW1lLCBwYXR0ZXJuc10gb2YgT2JqZWN0LmVudHJpZXMoUFJPSkVDVF9QQVRURVJOUykpIHsKICAgICAgICAgIGlmIChwYXR0ZXJucy5zb21lKHBhdHRlcm4gPT4gcGF0dGVybi50ZXN0KGxvd2VyVGl0bGUpKSkgewogICAgICAgICAgICBwcm9qZWN0ID0gcHJvak5hbWU7CiAgICAgICAgICAgIGNvbmZpZGVuY2UgPSAwLjg7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogIH0KICAKICAvLyBJZiBubyBzcGVjaWZpYyBwcm9qZWN0IGRldGVjdGVkLCBjaGVjayB0aXRsZSBwYXR0ZXJucwogIGlmICghcHJvamVjdCkgewogICAgY29uc3QgY29tYmluZWRUZXh0ID0gYCR7dGFiLnRpdGxlfSAke3RhYi51cmx9YC50b0xvd2VyQ2FzZSgpOwogICAgCiAgICBmb3IgKGNvbnN0IFtwcm9qTmFtZSwgcGF0dGVybnNdIG9mIE9iamVjdC5lbnRyaWVzKFBST0pFQ1RfUEFUVEVSTlMpKSB7CiAgICAgIGNvbnN0IG1hdGNoZXMgPSBwYXR0ZXJucy5maWx0ZXIocGF0dGVybiA9PiBwYXR0ZXJuLnRlc3QoY29tYmluZWRUZXh0KSkubGVuZ3RoOwogICAgICBpZiAobWF0Y2hlcyA+IDApIHsKICAgICAgICBwcm9qZWN0ID0gcHJvak5hbWU7CiAgICAgICAgY29uZmlkZW5jZSA9IE1hdGgubWluKDAuNywgbWF0Y2hlcyAqIDAuMik7CiAgICAgICAgdGFzayA9IGBXb3JraW5nIG9uICR7cHJvak5hbWV9YDsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogIH0KICAKICByZXR1cm4geyBwcm9qZWN0LCBjb25maWRlbmNlLCB0YXNrIH07Cn0KCi8vIExvZyBhY3Rpdml0eSB0byBTdXBhYmFzZQphc3luYyBmdW5jdGlvbiBsb2dDdXJyZW50QWN0aXZpdHkoKSB7CiAgaWYgKCFjdXJyZW50Q29udGV4dC5wcm9qZWN0KSByZXR1cm47CiAgCiAgY2hyb21lLnN0b3JhZ2UubG9jYWwuZ2V0KFsnc2VydmljZUtleScsICdlbmFibGVkJ10sIGFzeW5jIChkYXRhKSA9PiB7CiAgICBpZiAoIWRhdGEuc2VydmljZUtleSB8fCBkYXRhLmVuYWJsZWQgPT09IGZhbHNlKSByZXR1cm47CiAgICAKICAgIHRyeSB7CiAgICAgIC8vIEdldCBicm93c2VyIGluZm8gZm9yIHVuaXF1ZSBtYWNoaW5lIGlkZW50aWZpY2F0aW9uCiAgICAgIGNvbnN0IGJyb3dzZXJJbmZvID0gYXdhaXQgZ2V0QnJvd3NlckluZm8oKTsKICAgICAgY29uc3QgbWFjaGluZU5hbWUgPSBgJHticm93c2VySW5mby5icm93c2VyfSBFeHRlbnNpb24gKCR7YnJvd3NlckluZm8ub3N9KWA7CiAgICAgIAogICAgICAvLyBGaXJzdCwgZW5zdXJlIG1hY2hpbmUgZXhpc3RzIGluIGRhdGFiYXNlCiAgICAgIGF3YWl0IGVuc3VyZU1hY2hpbmVFeGlzdHMoZGF0YS5zZXJ2aWNlS2V5LCBtYWNoaW5lTmFtZSwgYnJvd3NlckluZm8pOwogICAgICAKICAgICAgY29uc3QgYWN0aXZpdHlEYXRhID0gewogICAgICAgIHVzZXJfaWQ6ICduZW9fdG9kYWsnLAogICAgICAgIGFjdGl2aXR5X3R5cGU6ICdicm93c2VyX2FjdGl2aXR5JywKICAgICAgICBhY3Rpdml0eV9kZXNjcmlwdGlvbjogY3VycmVudENvbnRleHQudGFzayB8fCBgV29ya2luZyBvbiAke2N1cnJlbnRDb250ZXh0LnByb2plY3R9YCwKICAgICAgICBwcm9qZWN0X25hbWU6IGN1cnJlbnRDb250ZXh0LnByb2plY3QsCiAgICAgICAgY3JlYXRlZF9hdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLAogICAgICAgIG1ldGFkYXRhOiB7CiAgICAgICAgICBjb25maWRlbmNlOiBjdXJyZW50Q29udGV4dC5jb25maWRlbmNlLAogICAgICAgICAgc291cmNlOiAnYnJvd3Nlcl9leHRlbnNpb24nLAogICAgICAgICAgbWFjaGluZTogbWFjaGluZU5hbWUsICAvLyBVc2UgY29uc2lzdGVudCBtYWNoaW5lIG5hbWUKICAgICAgICAgIGJyb3dzZXI6IGJyb3dzZXJJbmZvLmJyb3dzZXIsCiAgICAgICAgICBicm93c2VyX3ZlcnNpb246IGJyb3dzZXJJbmZvLnZlcnNpb24sCiAgICAgICAgICBvczogYnJvd3NlckluZm8ub3MKICAgICAgICB9CiAgICAgIH07CiAgICAgIAogICAgICAvLyBVc2UgdGhlIHVuaWZpZWQgbG9nZ2luZyBSUEMgZnVuY3Rpb24KICAgICAgY29uc3QgdW5pZmllZFBheWxvYWQgPSB7CiAgICAgICAgcF91c2VyX2lkOiAnbmVvX3RvZGFrJywKICAgICAgICBwX3Byb2plY3RfbmFtZTogY3VycmVudENvbnRleHQucHJvamVjdCwKICAgICAgICBwX2FjdGl2aXR5X3R5cGU6ICdicm93c2VyX2FjdGl2aXR5JywKICAgICAgICBwX2FjdGl2aXR5X2Rlc2NyaXB0aW9uOiBjdXJyZW50Q29udGV4dC50YXNrIHx8IGBXb3JraW5nIG9uICR7Y3VycmVudENvbnRleHQucHJvamVjdH1gLAogICAgICAgIHBfbWFjaGluZTogbWFjaGluZU5hbWUsCiAgICAgICAgcF9zb3VyY2U6ICdicm93c2VyX2V4dGVuc2lvbicsCiAgICAgICAgcF90b29sOiBicm93c2VySW5mby5icm93c2VyLAogICAgICAgIHBfaW1wb3J0YW5jZTogY3VycmVudENvbnRleHQuY29uZmlkZW5jZSA+IDAuOCA/ICdoaWdoJyA6ICdub3JtYWwnLAogICAgICAgIHBfYWRkaXRpb25hbF9tZXRhZGF0YTogewogICAgICAgICAgY29uZmlkZW5jZTogY3VycmVudENvbnRleHQuY29uZmlkZW5jZSwKICAgICAgICAgIGJyb3dzZXI6IGJyb3dzZXJJbmZvLmJyb3dzZXIsCiAgICAgICAgICBicm93c2VyX3ZlcnNpb246IGJyb3dzZXJJbmZvLnZlcnNpb24sCiAgICAgICAgICBvczogYnJvd3NlckluZm8ub3MsCiAgICAgICAgICB1cmw6IGN1cnJlbnRDb250ZXh0LnVybCB8fCAnJwogICAgICAgIH0KICAgICAgfTsKICAgICAgCiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2goYCR7U1VQQUJBU0VfVVJMfS9yZXN0L3YxL3JwYy9sb2dfYWN0aXZpdHlfdW5pZmllZGAsIHsKICAgICAgICBtZXRob2Q6ICdQT1NUJywKICAgICAgICBoZWFkZXJzOiB7CiAgICAgICAgICAnYXBpa2V5JzogZGF0YS5zZXJ2aWNlS2V5LAogICAgICAgICAgJ0F1dGhvcml6YXRpb24nOiBgQmVhcmVyICR7ZGF0YS5zZXJ2aWNlS2V5fWAsCiAgICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nCiAgICAgICAgfSwKICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh1bmlmaWVkUGF5bG9hZCkKICAgICAgfSk7CiAgICAgIAogICAgICBpZiAoIXJlc3BvbnNlLm9rKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBGYWlsZWQgdG8gbG9nIGFjdGl2aXR5OiAke2F3YWl0IHJlc3BvbnNlLnRleHQoKX1gKTsKICAgICAgfQogICAgICAKICAgICAgY29uc29sZS5sb2coJ0FjdGl2aXR5IGxvZ2dlZCBzdWNjZXNzZnVsbHkgdmlhIHVuaWZpZWQgbG9nZ2VyJyk7CiAgICAgIAogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgY29uc29sZS5lcnJvcignRXJyb3IgbG9nZ2luZyBhY3Rpdml0eTonLCBlcnJvcik7CiAgICB9CiAgfSk7Cn0KCi8vIEdldCBicm93c2VyIGluZm9ybWF0aW9uIGZvciB1bmlxdWUgbWFjaGluZSBpZGVudGlmaWNhdGlvbgphc3luYyBmdW5jdGlvbiBnZXRCcm93c2VySW5mbygpIHsKICAvLyBHZXQgYnJvd3NlciBuYW1lIGFuZCB2ZXJzaW9uCiAgY29uc3QgdXNlckFnZW50ID0gbmF2aWdhdG9yLnVzZXJBZ2VudDsKICBsZXQgYnJvd3NlciA9ICdVbmtub3duIEJyb3dzZXInOwogIGxldCB2ZXJzaW9uID0gJyc7CiAgCiAgaWYgKHVzZXJBZ2VudC5pbmNsdWRlcygnQ2hyb21lJykpIHsKICAgIGJyb3dzZXIgPSAnQ2hyb21lJzsKICAgIHZlcnNpb24gPSB1c2VyQWdlbnQubWF0Y2goL0Nocm9tZVwvKFswLTkuXSspLyk/LlsxXSB8fCAnJzsKICB9IGVsc2UgaWYgKHVzZXJBZ2VudC5pbmNsdWRlcygnRmlyZWZveCcpKSB7CiAgICBicm93c2VyID0gJ0ZpcmVmb3gnOwogICAgdmVyc2lvbiA9IHVzZXJBZ2VudC5tYXRjaCgvRmlyZWZveFwvKFswLTkuXSspLyk/LlsxXSB8fCAnJzsKICB9IGVsc2UgaWYgKHVzZXJBZ2VudC5pbmNsdWRlcygnU2FmYXJpJykpIHsKICAgIGJyb3dzZXIgPSAnU2FmYXJpJzsKICAgIHZlcnNpb24gPSB1c2VyQWdlbnQubWF0Y2goL1ZlcnNpb25cLyhbMC05Ll0rKS8pPy5bMV0gfHwgJyc7CiAgfSBlbHNlIGlmICh1c2VyQWdlbnQuaW5jbHVkZXMoJ0VkZ2UnKSkgewogICAgYnJvd3NlciA9ICdFZGdlJzsKICAgIHZlcnNpb24gPSB1c2VyQWdlbnQubWF0Y2goL0VkZ1wvKFswLTkuXSspLyk/LlsxXSB8fCAnJzsKICB9CiAgCiAgLy8gR2V0IE9TCiAgbGV0IG9zID0gJ1Vua25vd24gT1MnOwogIGlmICh1c2VyQWdlbnQuaW5jbHVkZXMoJ1dpbmRvd3MnKSkgb3MgPSAnV2luZG93cyc7CiAgZWxzZSBpZiAodXNlckFnZW50LmluY2x1ZGVzKCdNYWMnKSkgb3MgPSAnbWFjT1MnOwogIGVsc2UgaWYgKHVzZXJBZ2VudC5pbmNsdWRlcygnTGludXgnKSkgb3MgPSAnTGludXgnOwogIGVsc2UgaWYgKHVzZXJBZ2VudC5pbmNsdWRlcygnQW5kcm9pZCcpKSBvcyA9ICdBbmRyb2lkJzsKICBlbHNlIGlmICh1c2VyQWdlbnQuaW5jbHVkZXMoJ2lPUycpKSBvcyA9ICdpT1MnOwogIAogIHJldHVybiB7IGJyb3dzZXIsIHZlcnNpb24sIG9zIH07Cn0KCi8vIEVuc3VyZSBtYWNoaW5lIGV4aXN0cyBpbiBkYXRhYmFzZQphc3luYyBmdW5jdGlvbiBlbnN1cmVNYWNoaW5lRXhpc3RzKHNlcnZpY2VLZXksIG1hY2hpbmVOYW1lLCBicm93c2VySW5mbykgewogIHRyeSB7CiAgICAvLyBDaGVjayBpZiBtYWNoaW5lIGV4aXN0cwogICAgY29uc3QgY2hlY2tSZXNwb25zZSA9IGF3YWl0IGZldGNoKAogICAgICBgJHtTVVBBQkFTRV9VUkx9L3Jlc3QvdjEvY29udGV4dF9lbWJlZGRpbmdzP3R5cGU9ZXEubWFjaGluZSZuYW1lPWVxLiR7ZW5jb2RlVVJJQ29tcG9uZW50KG1hY2hpbmVOYW1lKX1gLAogICAgICB7CiAgICAgICAgaGVhZGVyczogewogICAgICAgICAgJ2FwaWtleSc6IHNlcnZpY2VLZXksCiAgICAgICAgICAnQXV0aG9yaXphdGlvbic6IGBCZWFyZXIgJHtzZXJ2aWNlS2V5fWAKICAgICAgICB9CiAgICAgIH0KICAgICk7CiAgICAKICAgIGNvbnN0IG1hY2hpbmVzID0gYXdhaXQgY2hlY2tSZXNwb25zZS5qc29uKCk7CiAgICAKICAgIGlmICghbWFjaGluZXMgfHwgbWFjaGluZXMubGVuZ3RoID09PSAwKSB7CiAgICAgIC8vIENyZWF0ZSBtYWNoaW5lIGVudHJ5CiAgICAgIGNvbnN0IG1hY2hpbmVEYXRhID0gewogICAgICAgIHR5cGU6ICdtYWNoaW5lJywKICAgICAgICBuYW1lOiBtYWNoaW5lTmFtZSwKICAgICAgICBwYXJlbnRfbmFtZTogJ25lb190b2RhaycsCiAgICAgICAgbWV0YWRhdGE6IHsKICAgICAgICAgIHVzZXJfaWQ6ICduZW9fdG9kYWsnLAogICAgICAgICAgbWFjaGluZV90eXBlOiAnYnJvd3Nlcl9leHRlbnNpb24nLAogICAgICAgICAgb3M6IGJyb3dzZXJJbmZvLm9zLAogICAgICAgICAgYnJvd3NlcjogYnJvd3NlckluZm8uYnJvd3NlciwKICAgICAgICAgIGJyb3dzZXJfdmVyc2lvbjogYnJvd3NlckluZm8udmVyc2lvbiwKICAgICAgICAgIGxvY2F0aW9uOiAnYnJvd3NlcicsCiAgICAgICAgICBpY29uOiAn8J+MkCcsCiAgICAgICAgICBjcmVhdGVkX2F0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkKICAgICAgICB9LAogICAgICAgIGVtYmVkZGluZzogbnVsbAogICAgICB9OwogICAgICAKICAgICAgYXdhaXQgZmV0Y2goYCR7U1VQQUJBU0VfVVJMfS9yZXN0L3YxL2NvbnRleHRfZW1iZWRkaW5nc2AsIHsKICAgICAgICBtZXRob2Q6ICdQT1NUJywKICAgICAgICBoZWFkZXJzOiB7CiAgICAgICAgICAnYXBpa2V5Jzogc2VydmljZUtleSwKICAgICAgICAgICdBdXRob3JpemF0aW9uJzogYEJlYXJlciAke3NlcnZpY2VLZXl9YCwKICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicKICAgICAgICB9LAogICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KG1hY2hpbmVEYXRhKQogICAgICB9KTsKICAgICAgCiAgICAgIGNvbnNvbGUubG9nKCdDcmVhdGVkIG5ldyBtYWNoaW5lIGVudHJ5OicsIG1hY2hpbmVOYW1lKTsKICAgIH0KICB9IGNhdGNoIChlcnJvcikgewogICAgY29uc29sZS5lcnJvcignRXJyb3IgZW5zdXJpbmcgbWFjaGluZSBleGlzdHM6JywgZXJyb3IpOwogIH0KfQoKLy8gVXBkYXRlIGV4dGVuc2lvbiBiYWRnZQpmdW5jdGlvbiB1cGRhdGVCYWRnZShwcm9qZWN0KSB7CiAgaWYgKCFwcm9qZWN0KSB7CiAgICBjaHJvbWUuYWN0aW9uLnNldEJhZGdlVGV4dCh7IHRleHQ6ICcnIH0pOwogICAgcmV0dXJuOwogIH0KICAKICAvLyBTaG93IGFiYnJldmlhdGVkIHByb2plY3QgbmFtZQogIGNvbnN0IGJhZGdlID0gcHJvamVjdC5zdWJzdHJpbmcoMCwgMikudG9VcHBlckNhc2UoKTsKICBjaHJvbWUuYWN0aW9uLnNldEJhZGdlVGV4dCh7IHRleHQ6IGJhZGdlIH0pOwogIGNocm9tZS5hY3Rpb24uc2V0QmFkZ2VCYWNrZ3JvdW5kQ29sb3IoeyBjb2xvcjogJyMyMTk2RjMnIH0pOwp9CgovLyBNZXNzYWdlIGhhbmRsZXIgZm9yIHBvcHVwCmNocm9tZS5ydW50aW1lLm9uTWVzc2FnZS5hZGRMaXN0ZW5lcigocmVxdWVzdCwgc2VuZGVyLCBzZW5kUmVzcG9uc2UpID0+IHsKICBpZiAocmVxdWVzdC5hY3Rpb24gPT09ICdnZXRDb250ZXh0JykgewogICAgc2VuZFJlc3BvbnNlKGN1cnJlbnRDb250ZXh0KTsKICB9IGVsc2UgaWYgKHJlcXVlc3QuYWN0aW9uID09PSAnZm9yY2VDaGVjaycpIHsKICAgIGNoZWNrQ3VycmVudENvbnRleHQoKS50aGVuKCgpID0+IHsKICAgICAgc2VuZFJlc3BvbnNlKGN1cnJlbnRDb250ZXh0KTsKICAgIH0pOwogICAgcmV0dXJuIHRydWU7IC8vIEtlZXAgY2hhbm5lbCBvcGVuIGZvciBhc3luYyByZXNwb25zZQogIH0gZWxzZSBpZiAocmVxdWVzdC5hY3Rpb24gPT09ICdsb2dBY3Rpdml0eScpIHsKICAgIGxvZ0N1cnJlbnRBY3Rpdml0eSgpLnRoZW4oKCkgPT4gewogICAgICBzZW5kUmVzcG9uc2UoeyBzdWNjZXNzOiB0cnVlIH0pOwogICAgfSk7CiAgICByZXR1cm4gdHJ1ZTsKICB9Cn0pOw==
EOF

    echo "Creating popup.html..."
    cat << 'EOF' | base64 -d > "$EXTENSION_DIR/popup.html"
PCFET0NUWVBFIGh0bWw+CjxodG1sPgo8aGVhZD4KICAgIDxtZXRhIGNoYXJzZXQ9IlVURi04Ij4KICAgIDxzdHlsZT4KICAgICAgICBib2R5IHsKICAgICAgICAgICAgd2lkdGg6IDMwMHB4OwogICAgICAgICAgICBwYWRkaW5nOiAxNXB4OwogICAgICAgICAgICBmb250LWZhbWlseTogLWFwcGxlLXN5c3RlbSwgQmxpbmtNYWNTeXN0ZW1Gb250LCAnU2Vnb2UgVUknLCBzYW5zLXNlcmlmOwogICAgICAgICAgICBtYXJnaW46IDA7CiAgICAgICAgfQogICAgICAgIGgyIHsKICAgICAgICAgICAgbWFyZ2luOiAwIDAgMTVweCAwOwogICAgICAgICAgICBjb2xvcjogIzIxOTZGMzsKICAgICAgICAgICAgZm9udC1zaXplOiAxOHB4OwogICAgICAgIH0KICAgICAgICAuc3RhdHVzIHsKICAgICAgICAgICAgcGFkZGluZzogMTVweDsKICAgICAgICAgICAgYmFja2dyb3VuZDogI2Y1ZjVmNTsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogOHB4OwogICAgICAgICAgICBtYXJnaW4tYm90dG9tOiAxNXB4OwogICAgICAgIH0KICAgICAgICAuc3RhdHVzLmFjdGl2ZSB7CiAgICAgICAgICAgIGJhY2tncm91bmQ6ICNlM2YyZmQ7CiAgICAgICAgICAgIGJvcmRlcjogMXB4IHNvbGlkICMyMTk2RjM7CiAgICAgICAgfQogICAgICAgIC5wcm9qZWN0LW5hbWUgewogICAgICAgICAgICBmb250LXNpemU6IDE2cHg7CiAgICAgICAgICAgIGZvbnQtd2VpZ2h0OiBib2xkOwogICAgICAgICAgICBtYXJnaW4tYm90dG9tOiA1cHg7CiAgICAgICAgfQogICAgICAgIC50YXNrIHsKICAgICAgICAgICAgZm9udC1zaXplOiAxNHB4OwogICAgICAgICAgICBjb2xvcjogIzY2NjsKICAgICAgICAgICAgbWFyZ2luLWJvdHRvbTogNXB4OwogICAgICAgIH0KICAgICAgICAuY29uZmlkZW5jZSB7CiAgICAgICAgICAgIGZvbnQtc2l6ZTogMTJweDsKICAgICAgICAgICAgY29sb3I6ICM5OTk7CiAgICAgICAgfQogICAgICAgIC5jb25maWRlbmNlLWJhciB7CiAgICAgICAgICAgIHdpZHRoOiAxMDAlOwogICAgICAgICAgICBoZWlnaHQ6IDRweDsKICAgICAgICAgICAgYmFja2dyb3VuZDogI2RkZDsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogMnB4OwogICAgICAgICAgICBtYXJnaW4tdG9wOiA1cHg7CiAgICAgICAgICAgIG92ZXJmbG93OiBoaWRkZW47CiAgICAgICAgfQogICAgICAgIC5jb25maWRlbmNlLWZpbGwgewogICAgICAgICAgICBoZWlnaHQ6IDEwMCU7CiAgICAgICAgICAgIGJhY2tncm91bmQ6ICMyMTk2RjM7CiAgICAgICAgICAgIHRyYW5zaXRpb246IHdpZHRoIDAuM3M7CiAgICAgICAgfQogICAgICAgIGJ1dHRvbiB7CiAgICAgICAgICAgIHdpZHRoOiAxMDAlOwogICAgICAgICAgICBwYWRkaW5nOiAxMHB4OwogICAgICAgICAgICBib3JkZXI6IG5vbmU7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDZweDsKICAgICAgICAgICAgYmFja2dyb3VuZDogIzIxOTZGMzsKICAgICAgICAgICAgY29sb3I6IHdoaXRlOwogICAgICAgICAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICAgICAgICAgIG1hcmdpbi1ib3R0b206IDEwcHg7CiAgICAgICAgfQogICAgICAgIGJ1dHRvbjpob3ZlciB7CiAgICAgICAgICAgIGJhY2tncm91bmQ6ICMxOTc2RDI7CiAgICAgICAgfQogICAgICAgIGJ1dHRvbjpkaXNhYmxlZCB7CiAgICAgICAgICAgIGJhY2tncm91bmQ6ICNjY2M7CiAgICAgICAgICAgIGN1cnNvcjogbm90LWFsbG93ZWQ7CiAgICAgICAgfQogICAgICAgIC5zZXR0aW5ncyB7CiAgICAgICAgICAgIG1hcmdpbi10b3A6IDE1cHg7CiAgICAgICAgICAgIHBhZGRpbmctdG9wOiAxNXB4OwogICAgICAgICAgICBib3JkZXItdG9wOiAxcHggc29saWQgI2RkZDsKICAgICAgICB9CiAgICAgICAgaW5wdXQgewogICAgICAgICAgICB3aWR0aDogMTAwJTsKICAgICAgICAgICAgcGFkZGluZzogOHB4OwogICAgICAgICAgICBib3JkZXI6IDFweCBzb2xpZCAjZGRkOwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiA0cHg7CiAgICAgICAgICAgIG1hcmdpbi1ib3R0b206IDEwcHg7CiAgICAgICAgICAgIGJveC1zaXppbmc6IGJvcmRlci1ib3g7CiAgICAgICAgfQogICAgICAgIC50b2dnbGUgewogICAgICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgICAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgICAgICAgICBqdXN0aWZ5LWNvbnRlbnQ6IHNwYWNlLWJldHdlZW47CiAgICAgICAgICAgIG1hcmdpbi1ib3R0b206IDEwcHg7CiAgICAgICAgfQogICAgICAgIC5zd2l0Y2ggewogICAgICAgICAgICBwb3NpdGlvbjogcmVsYXRpdmU7CiAgICAgICAgICAgIHdpZHRoOiA0MHB4OwogICAgICAgICAgICBoZWlnaHQ6IDIwcHg7CiAgICAgICAgfQogICAgICAgIC5zd2l0Y2ggaW5wdXQgewogICAgICAgICAgICBvcGFjaXR5OiAwOwogICAgICAgICAgICB3aWR0aDogMDsKICAgICAgICAgICAgaGVpZ2h0OiAwOwogICAgICAgIH0KICAgICAgICAuc2xpZGVyIHsKICAgICAgICAgICAgcG9zaXRpb246IGFic29sdXRlOwogICAgICAgICAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICAgICAgICAgIHRvcDogMDsKICAgICAgICAgICAgbGVmdDogMDsKICAgICAgICAgICAgcmlnaHQ6IDA7CiAgICAgICAgICAgIGJvdHRvbTogMDsKICAgICAgICAgICAgYmFja2dyb3VuZC1jb2xvcjogI2NjYzsKICAgICAgICAgICAgdHJhbnNpdGlvbjogLjRzOwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiAyMHB4OwogICAgICAgIH0KICAgICAgICAuc2xpZGVyOmJlZm9yZSB7CiAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgICAgICAgICAgY29udGVudDogIiI7CiAgICAgICAgICAgIGhlaWdodDogMTRweDsKICAgICAgICAgICAgd2lkdGg6IDE0cHg7CiAgICAgICAgICAgIGxlZnQ6IDNweDsKICAgICAgICAgICAgYm90dG9tOiAzcHg7CiAgICAgICAgICAgIGJhY2tncm91bmQtY29sb3I6IHdoaXRlOwogICAgICAgICAgICB0cmFuc2l0aW9uOiAuNHM7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgICAgICB9CiAgICAgICAgaW5wdXQ6Y2hlY2tlZCArIC5zbGlkZXIgewogICAgICAgICAgICBiYWNrZ3JvdW5kLWNvbG9yOiAjMjE5NkYzOwogICAgICAgIH0KICAgICAgICBpbnB1dDpjaGVja2VkICsgLnNsaWRlcjpiZWZvcmUgewogICAgICAgICAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoMjBweCk7CiAgICAgICAgfQogICAgICAgIC5uby1jb250ZXh0IHsKICAgICAgICAgICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgICAgICAgICBjb2xvcjogIzk5OTsKICAgICAgICAgICAgcGFkZGluZzogMjBweDsKICAgICAgICB9CiAgICA8L3N0eWxlPgo8L2hlYWQ+Cjxib2R5PgogICAgPGgyPvCfjIogRmxvd1N0YXRlIFRyYWNrZXI8L2gyPgogICAgCiAgICA8ZGl2IGlkPSJjb250ZXh0RGlzcGxheSIgY2xhc3M9InN0YXR1cyI+CiAgICAgICAgPGRpdiBjbGFzcz0ibm8tY29udGV4dCI+RGV0ZWN0aW5nIGNvbnRleHQuLi48L2Rpdj4KICAgIDwvZGl2PgogICAgCiAgICA8YnV0dG9uIGlkPSJyZWZyZXNoQnRuIj5SZWZyZXNoIENvbnRleHQ8L2J1dHRvbj4KICAgIDxidXR0b24gaWQ9ImxvZ0J0biI+TG9nIEFjdGl2aXR5IE5vdzwvYnV0dG9uPgogICAgCiAgICA8ZGl2IGNsYXNzPSJzZXR0aW5ncyI+CiAgICAgICAgPGRpdiBjbGFzcz0idG9nZ2xlIj4KICAgICAgICAgICAgPHNwYW4+RW5hYmxlIFRyYWNraW5nPC9zcGFuPgogICAgICAgICAgICA8bGFiZWwgY2xhc3M9InN3aXRjaCI+CiAgICAgICAgICAgICAgICA8aW5wdXQgdHlwZT0iY2hlY2tib3giIGlkPSJlbmFibGVUb2dnbGUiIGNoZWNrZWQ+CiAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0ic2xpZGVyIj48L3NwYW4+CiAgICAgICAgICAgIDwvbGFiZWw+CiAgICAgICAgPC9kaXY+CiAgICAgICAgCiAgICAgICAgPGlucHV0IHR5cGU9InBhc3N3b3JkIiBpZD0ic2VydmljZUtleSIgcGxhY2Vob2xkZXI9IlN1cGFiYXNlIFNlcnZpY2UgS2V5Ij4KICAgICAgICA8YnV0dG9uIGlkPSJzYXZlQnRuIj5TYXZlIFNldHRpbmdzPC9idXR0b24+CiAgICA8L2Rpdj4KICAgIAogICAgPHNjcmlwdCBzcmM9InBvcHVwLmpzIj48L3NjcmlwdD4KPC9ib2R5Pgo8L2h0bWw+
EOF

    echo "Creating popup.js..."
    cat << 'EOF' | base64 -d > "$EXTENSION_DIR/popup.js"
Ly8gRmxvd1N0YXRlIEJyb3dzZXIgRXh0ZW5zaW9uIC0gUG9wdXAgU2NyaXB0Cgpkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdET01Db250ZW50TG9hZGVkJywgYXN5bmMgKCkgPT4gewogICAgLy8gTG9hZCBzYXZlZCBzZXR0aW5ncwogICAgY29uc3Qgc2V0dGluZ3MgPSBhd2FpdCBjaHJvbWUuc3RvcmFnZS5sb2NhbC5nZXQoWydzZXJ2aWNlS2V5JywgJ2VuYWJsZWQnXSk7CiAgICAKICAgIGlmIChzZXR0aW5ncy5zZXJ2aWNlS2V5KSB7CiAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NlcnZpY2VLZXknKS52YWx1ZSA9IHNldHRpbmdzLnNlcnZpY2VLZXk7CiAgICB9CiAgICAKICAgIGlmIChzZXR0aW5ncy5lbmFibGVkICE9PSB1bmRlZmluZWQpIHsKICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZW5hYmxlVG9nZ2xlJykuY2hlY2tlZCA9IHNldHRpbmdzLmVuYWJsZWQ7CiAgICB9CiAgICAKICAgIC8vIEdldCBjdXJyZW50IGNvbnRleHQKICAgIHVwZGF0ZUNvbnRleHREaXNwbGF5KCk7CiAgICAKICAgIC8vIEJ1dHRvbiBoYW5kbGVycwogICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3JlZnJlc2hCdG4nKS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGFzeW5jICgpID0+IHsKICAgICAgICBjb25zdCBidG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmVmcmVzaEJ0bicpOwogICAgICAgIGJ0bi5kaXNhYmxlZCA9IHRydWU7CiAgICAgICAgYnRuLnRleHRDb250ZW50ID0gJ1JlZnJlc2hpbmcuLi4nOwogICAgICAgIAogICAgICAgIGNocm9tZS5ydW50aW1lLnNlbmRNZXNzYWdlKHsgYWN0aW9uOiAnZm9yY2VDaGVjaycgfSwgKHJlc3BvbnNlKSA9PiB7CiAgICAgICAgICAgIHVwZGF0ZUNvbnRleHREaXNwbGF5KCk7CiAgICAgICAgICAgIGJ0bi5kaXNhYmxlZCA9IGZhbHNlOwogICAgICAgICAgICBidG4udGV4dENvbnRlbnQgPSAnUmVmcmVzaCBDb250ZXh0JzsKICAgICAgICB9KTsKICAgIH0pOwogICAgCiAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbG9nQnRuJykuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBhc3luYyAoKSA9PiB7CiAgICAgICAgY29uc3QgYnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2xvZ0J0bicpOwogICAgICAgIGJ0bi5kaXNhYmxlZCA9IHRydWU7CiAgICAgICAgYnRuLnRleHRDb250ZW50ID0gJ0xvZ2dpbmcuLi4nOwogICAgICAgIAogICAgICAgIGNocm9tZS5ydW50aW1lLnNlbmRNZXNzYWdlKHsgYWN0aW9uOiAnbG9nQWN0aXZpdHknIH0sIChyZXNwb25zZSkgPT4gewogICAgICAgICAgICBidG4uZGlzYWJsZWQgPSBmYWxzZTsKICAgICAgICAgICAgYnRuLnRleHRDb250ZW50ID0gJ0xvZyBBY3Rpdml0eSBOb3cnOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHJlc3BvbnNlICYmIHJlc3BvbnNlLnN1Y2Nlc3MpIHsKICAgICAgICAgICAgICAgIHNob3dTdGF0dXMoJ0FjdGl2aXR5IGxvZ2dlZCEnKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgfSk7CiAgICAKICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzYXZlQnRuJykuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBhc3luYyAoKSA9PiB7CiAgICAgICAgY29uc3Qgc2VydmljZUtleSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzZXJ2aWNlS2V5JykudmFsdWU7CiAgICAgICAgY29uc3QgZW5hYmxlZCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdlbmFibGVUb2dnbGUnKS5jaGVja2VkOwogICAgICAgIAogICAgICAgIGF3YWl0IGNocm9tZS5zdG9yYWdlLmxvY2FsLnNldCh7IHNlcnZpY2VLZXksIGVuYWJsZWQgfSk7CiAgICAgICAgc2hvd1N0YXR1cygnU2V0dGluZ3Mgc2F2ZWQhJyk7CiAgICAgICAgCiAgICAgICAgLy8gVHJpZ2dlciBpbW1lZGlhdGUgY29udGV4dCBjaGVjayBhbmQgdXBkYXRlCiAgICAgICAgY2hyb21lLnJ1bnRpbWUuc2VuZE1lc3NhZ2UoeyBhY3Rpb246ICdmb3JjZUNoZWNrJyB9LCAocmVzcG9uc2UpID0+IHsKICAgICAgICAgICAgdXBkYXRlQ29udGV4dERpc3BsYXkoKTsKICAgICAgICAgICAgaWYgKGVuYWJsZWQgJiYgc2VydmljZUtleSkgewogICAgICAgICAgICAgICAgc2hvd1N0YXR1cygnRXh0ZW5zaW9uIGFjdGl2YXRlZCEgQ2hlY2tpbmcgY29udGV4dC4uLicpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9KTsKICAgIAogICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2VuYWJsZVRvZ2dsZScpLmFkZEV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsIGFzeW5jIChlKSA9PiB7CiAgICAgICAgYXdhaXQgY2hyb21lLnN0b3JhZ2UubG9jYWwuc2V0KHsgZW5hYmxlZDogZS50YXJnZXQuY2hlY2tlZCB9KTsKICAgIH0pOwp9KTsKCmZ1bmN0aW9uIHVwZGF0ZUNvbnRleHREaXNwbGF5KCkgewogICAgY2hyb21lLnJ1bnRpbWUuc2VuZE1lc3NhZ2UoeyBhY3Rpb246ICdnZXRDb250ZXh0JyB9LCAoY29udGV4dCkgPT4gewogICAgICAgIGNvbnN0IGRpc3BsYXkgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY29udGV4dERpc3BsYXknKTsKICAgICAgICAKICAgICAgICBpZiAoIWNvbnRleHQgfHwgIWNvbnRleHQucHJvamVjdCkgewogICAgICAgICAgICBkaXNwbGF5LmlubmVySFRNTCA9ICc8ZGl2IGNsYXNzPSJuby1jb250ZXh0Ij5ObyBhY3RpdmUgcHJvamVjdCBkZXRlY3RlZDwvZGl2Pic7CiAgICAgICAgICAgIGRpc3BsYXkuY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgZGlzcGxheS5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICBkaXNwbGF5LmlubmVySFRNTCA9IGAKICAgICAgICAgICAgPGRpdiBjbGFzcz0icHJvamVjdC1uYW1lIj4ke2NvbnRleHQucHJvamVjdH08L2Rpdj4KICAgICAgICAgICAgPGRpdiBjbGFzcz0idGFzayI+JHtjb250ZXh0LnRhc2sgfHwgJ0dlbmVyYWwgd29yayd9PC9kaXY+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9ImNvbmZpZGVuY2UiPgogICAgICAgICAgICAgICAgQ29uZmlkZW5jZTogJHtNYXRoLnJvdW5kKGNvbnRleHQuY29uZmlkZW5jZSAqIDEwMCl9JQogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBjbGFzcz0iY29uZmlkZW5jZS1iYXIiPgogICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iY29uZmlkZW5jZS1maWxsIiBzdHlsZT0id2lkdGg6ICR7Y29udGV4dC5jb25maWRlbmNlICogMTAwfSUiPjwvZGl2PgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICBgOwogICAgfSk7Cn0KCmZ1bmN0aW9uIHNob3dTdGF0dXMobWVzc2FnZSkgewogICAgY29uc3QgYnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NhdmVCdG4nKTsKICAgIGNvbnN0IG9yaWdpbmFsVGV4dCA9IGJ0bi50ZXh0Q29udGVudDsKICAgIGJ0bi50ZXh0Q29udGVudCA9IG1lc3NhZ2U7CiAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICBidG4udGV4dENvbnRlbnQgPSBvcmlnaW5hbFRleHQ7CiAgICB9LCAyMDAwKTsKfQ==
EOF

    echo "Creating icon16.png..."
    cat << 'EOF' | base64 -d > "$EXTENSION_DIR/icon16.png"
iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAA7AAAAOwBeShxvQAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAABPSURBVDiN7Y4xCgAwCAN3/v+zHRxELYKD0DkItyQEQETkRkb1AaBqAS5nZ/cFmJkPgKoWYGcPzOwTwN0LsLNb/w7M7AWoun0Cd/8EZvaSDR4hKQ9nQ4ujAAAAAElFTkSuQmCC
EOF

    echo "Creating icon48.png..."
    cat << 'EOF' | base64 -d > "$EXTENSION_DIR/icon48.png"
iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAA7AAAAOwBeShxvQAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAABwSURBVGiB7dihDcAwDETRl2XJMmQZsgyZJcswTJcFSiGDolCQ/S+5Vc4nOTkiIs6mqiZ2Zna8SxERd5IkSZKkf1TV5HneAfQk7T1PE5GZ2YGYGRFBP6mqiTnndQBXkvae0TSYmR2I3gfozOwXJEl64gGhiyUhjV/PCQAAAABJRU5ErkJggg==
EOF

    echo "Creating icon128.png..."
    cat << 'EOF' | base64 -d > "$EXTENSION_DIR/icon128.png"
iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAA7AAAAOwBeShxvQAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAACXSURBVHic7duxDYAwDETRh2UsQxYiy5BlmC4LQAEUKATZeq9y5fycZEeSpL+oqsnd3V1EvCfOzKoGZmZHZGZExPshqmqCu7u7iIj3xJlZ1cDM7IjMjKn5PoADMjM6MDPb+wCOSLsPoKqmmJlddwAzs6qBu7u7iIj3xJlZ1cDM7IjMjIh4T5yaVQ3MzI7I9wFI0vAeEUUzCJdnGBsAAAAASUVORK5CYII=
EOF

    echo "Files extracted successfully"
}


extract_files

# Instructions
echo
echo "==================================="
echo "INSTALLATION INSTRUCTIONS:"
echo "==================================="
echo "1. Opening Chrome to extensions page..."
echo "2. Enable 'Developer mode' (toggle in top right)"
echo "3. Click 'Load unpacked'"
echo "4. Navigate to: $EXTENSION_DIR"
echo "5. Click 'Select'"
echo
echo "After installation:"
echo "- Click the FlowState icon in toolbar"
echo "- Enter your service key"
echo "- Enable tracking"
echo "==================================="
echo

# Open Chrome extensions page
open -a "Google Chrome" "chrome://extensions/" 2>/dev/null || \
open -a "Google Chrome" --args --new-window "chrome://extensions/" 2>/dev/null

# Also try other browsers
open -a "Microsoft Edge" "edge://extensions/" 2>/dev/null &
open -a "Brave Browser" "brave://extensions/" 2>/dev/null &

echo "Extension files installed to: $EXTENSION_DIR"
echo "Press Enter to exit..."
read