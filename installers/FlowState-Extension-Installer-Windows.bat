@echo off
echo ===================================
echo FlowState Browser Extension Installer
echo ===================================
echo.

:: Check if running as admin
net session >nul 2>&1
if %errorLevel% neq 0 (
    echo This installer needs to run as Administrator.
    echo Right-click and select "Run as administrator"
    pause
    exit /b 1
)

:: Set extension directory
set EXTENSION_DIR=%LOCALAPPDATA%\FlowState\browser-extension

:: Create directory
echo Creating extension directory...
if not exist "%EXTENSION_DIR%" mkdir "%EXTENSION_DIR%"

:: Extract extension files (they'll be embedded in the installer)
echo Extracting extension files...
call :ExtractFiles

:: Open Chrome to extensions page
echo.
echo ===================================
echo INSTALLATION INSTRUCTIONS:
echo ===================================
echo 1. Chrome will open to the extensions page
echo 2. Enable "Developer mode" (toggle in top right)
echo 3. Click "Load unpacked"
echo 4. Navigate to: %EXTENSION_DIR%
echo 5. Click "Select Folder"
echo.
echo After installation:
echo - Click the FlowState icon in toolbar
echo - Enter your service key
echo - Enable tracking
echo ===================================
echo.
echo Press any key to open Chrome...
pause >nul

:: Open Chrome extensions page
start chrome://extensions/

:: Also try Edge
start msedge://extensions/ 2>nul

echo.
echo Extension files installed to: %EXTENSION_DIR%
echo.
pause
exit /b 0

:ExtractFiles
echo Creating manifest.json...
(
echo ewogICJtYW5pZmVzdF92ZXJzaW9uIjogMywKICAibmFtZSI6ICJGbG93U3RhdGUgU3RhdHVzIFZpZXdlciIsCiAgInZlcnNpb24iOiAiMi4wLjAiLAogICJkZXNjcmlwdGlvbiI6ICJWaWV3IHlvdXIgY3VycmVudCBGbG93U3RhdGUgYWN0aXZpdGllcyBhY3Jvc3MgYWxsIG1hY2hpbmVzIiwKICAicGVybWlzc2lvbnMiOiBbCiAgICAic3RvcmFnZSIsCiAgICAiYWxhcm1zIgogIF0sCiAgImhvc3RfcGVybWlzc2lvbnMiOiBbCiAgICAiaHR0cHM6Ly8qLnN1cGFiYXNlLmNvLyoiCiAgXSwKICAiYmFja2dyb3VuZCI6IHsKICAgICJzZXJ2aWNlX3dvcmtlciI6ICJiYWNrZ3JvdW5kLmpzIgogIH0sCiAgImFjdGlvbiI6IHsKICAgICJkZWZhdWx0X3BvcHVwIjogInBvcHVwLmh0bWwiLAogICAgImRlZmF1bHRfaWNvbiI6IHsKICAgICAgIjE2IjogImljb24xNi5wbmciLAogICAgICAiNDgiOiAiaWNvbjQ4LnBuZyIsCiAgICAgICIxMjgiOiAiaWNvbjEyOC5wbmciCiAgICB9CiAgfSwKICAiaWNvbnMiOiB7CiAgICAiMTYiOiAiaWNvbjE2LnBuZyIsCiAgICAiNDgiOiAiaWNvbjQ4LnBuZyIsCiAgICAiMTI4IjogImljb24xMjgucG5nIgogIH0sCiAgIm9wdGlvbnNfcGFnZSI6ICJkZWJ1Zy5odG1sIgp9
) > "%EXTENSION_DIR%\manifest.json.b64"
certutil -decode "%EXTENSION_DIR%\manifest.json.b64" "%EXTENSION_DIR%\manifest.json" >nul
del "%EXTENSION_DIR%\manifest.json.b64"

echo Creating background.js...
(
echo Ly8gRmxvd1N0YXRlIEJyb3dzZXIgRXh0ZW5zaW9uIC0gU3RhdHVzIFZpZXdlcgovLyBTaG93cyB5b3VyIGN1cnJlbnQgRmxvd1N0YXRlIGFjdGl2aXRpZXMgZnJvbSBhbGwgbWFjaGluZXMKCmNvbnN0IFNVUEFCQVNFX1VSTCA9ICdodHRwczovL3V6YW1hbXltZnpoZWx2a3dwdmd0LnN1cGFiYXNlLmNvJzsKY29uc3QgUkVGUkVTSF9JTlRFUlZBTCA9IDMwMDAwOyAvLyBSZWZyZXNoIGV2ZXJ5IDMwIHNlY29uZHMKCmxldCBjdXJyZW50Rmxvd1N0YXRlID0gewogIGFjdGl2aXRpZXM6IFtdLAogIG1hY2hpbmVzOiBbXSwKICBjdXJyZW50UHJvamVjdDogbnVsbCwKICBsYXN0VXBkYXRlZDogbnVsbCwKICBlcnJvcjogbnVsbAp9OwoKLy8gSW5pdGlhbGl6ZSBleHRlbnNpb24KY2hyb21lLnJ1bnRpbWUub25JbnN0YWxsZWQuYWRkTGlzdGVuZXIoKCkgPT4gewogIGNvbnNvbGUubG9nKCdGbG93U3RhdGUgU3RhdHVzIFZpZXdlciBpbnN0YWxsZWQnKTsKICAKICAvLyBTZXQgdXAgcGVyaW9kaWMgcmVmcmVzaAogIGNocm9tZS5hbGFybXMuY3JlYXRlKCdyZWZyZXNoRmxvd1N0YXRlJywgeyBwZXJpb2RJbk1pbnV0ZXM6IDAuNSB9KTsKICAKICAvLyBJbml0aWFsIHN0YXRlCiAgY2hyb21lLnN0b3JhZ2UubG9jYWwuc2V0KHsgCiAgICBjdXJyZW50Rmxvd1N0YXRlOiB7CiAgICAgIC4uLmN1cnJlbnRGbG93U3RhdGUsCiAgICAgIGVycm9yOiAnRXh0ZW5zaW9uIGp1c3QgaW5zdGFsbGVkLiBQbGVhc2UgY29uZmlndXJlIHlvdXIgc2Vy
echo dmljZSBrZXkuJwogICAgfQogIH0pOwogIAogIC8vIExvYWQgc2F2ZWQgY29uZmlndXJhdGlvbgogIGNocm9tZS5zdG9yYWdlLmxvY2FsLmdldChbJ3NlcnZpY2VLZXknLCAnZW5hYmxlZCddLCAoZGF0YSkgPT4gewogICAgaWYgKCFkYXRhLnNlcnZpY2VLZXkpIHsKICAgICAgY29uc29sZS5sb2coJ1NlcnZpY2Uga2V5IG5vdCBjb25maWd1cmVkJyk7CiAgICAgIHVwZGF0ZUJhZGdlKCchJyk7CiAgICB9IGVsc2UgewogICAgICAvLyBJbml0aWFsIGZldGNoCiAgICAgIGZldGNoRmxvd1N0YXRlKCk7CiAgICB9CiAgfSk7Cn0pOwoKLy8gTGlzdGVuIGZvciBhbGFybSBldmVudHMKY2hyb21lLmFsYXJtcy5vbkFsYXJtLmFkZExpc3RlbmVyKChhbGFybSkgPT4gewogIGlmIChhbGFybS5uYW1lID09PSAncmVmcmVzaEZsb3dTdGF0ZScpIHsKICAgIGNocm9tZS5zdG9yYWdlLmxvY2FsLmdldChbJ2VuYWJsZWQnXSwgKGRhdGEpID0+IHsKICAgICAgaWYgKGRhdGEuZW5hYmxlZCAhPT0gZmFsc2UpIHsKICAgICAgICBmZXRjaEZsb3dTdGF0ZSgpOwogICAgICB9CiAgICB9KTsKICB9Cn0pOwoKLy8gTWFpbiBmdW5jdGlvbiB0byBmZXRjaCBGbG93U3RhdGUgZGF0YQphc3luYyBmdW5jdGlvbiBmZXRjaEZsb3dTdGF0ZSgpIHsKICBjb25zb2xlLmxvZygnRmV0Y2hpbmcgRmxvd1N0YXRlIGRhdGEuLi4nKTsKICAKICB0cnkgewogICAgY29uc3QgZGF0YSA9IGF3YWl0IGNocm9tZS5zdG9yYWdlLmxvY2FsLmdldChbJ3NlcnZpY2VLZXkn
echo LCAnZW5hYmxlZCddKTsKICAgIAogICAgaWYgKCFkYXRhLnNlcnZpY2VLZXkpIHsKICAgICAgY3VycmVudEZsb3dTdGF0ZSA9IHsKICAgICAgICAuLi5jdXJyZW50Rmxvd1N0YXRlLAogICAgICAgIGVycm9yOiAnTm8gc2VydmljZSBrZXkgY29uZmlndXJlZCcsCiAgICAgICAgbGFzdFVwZGF0ZWQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKQogICAgICB9OwogICAgICBjaHJvbWUuc3RvcmFnZS5sb2NhbC5zZXQoeyBjdXJyZW50Rmxvd1N0YXRlIH0pOwogICAgICB1cGRhdGVCYWRnZSgnIScpOwogICAgICByZXR1cm47CiAgICB9CiAgICAKICAgIGlmIChkYXRhLmVuYWJsZWQgPT09IGZhbHNlKSB7CiAgICAgIGNvbnNvbGUubG9nKCdFeHRlbnNpb24gaXMgZGlzYWJsZWQnKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgCiAgICAvLyBGZXRjaCByZWNlbnQgYWN0aXZpdGllcyAobGFzdCAyIGhvdXJzKQogICAgY29uc3QgdHdvSG91cnNBZ28gPSBuZXcgRGF0ZShEYXRlLm5vdygpIC0gMiAqIDYwICogNjAgKiAxMDAwKS50b0lTT1N0cmluZygpOwogICAgCiAgICBjb25zb2xlLmxvZygnRmV0Y2hpbmcgZnJvbTonLCBgJHtTVVBBQkFTRV9VUkx9L3Jlc3QvdjEvZmxvd3N0YXRlX2FjdGl2aXRpZXNgKTsKICAgIAogICAgLy8gR2V0IGFjdGl2aXRpZXMgdXNpbmcgdGhlIHZpZXcKICAgIGNvbnN0IGFjdGl2aXRpZXNSZXNwb25zZSA9IGF3YWl0IGZldGNoKAogICAgICBgJHtTVVBBQkFTRV9VUkx9L3Jlc3QvdjEvZmxvd3N0YXRl
echo X2FjdGl2aXRpZXM/Y3JlYXRlZF9hdD1ndGUuJHt0d29Ib3Vyc0Fnb30mb3JkZXI9Y3JlYXRlZF9hdC5kZXNjJmxpbWl0PTIwYCwKICAgICAgewogICAgICAgIG1ldGhvZDogJ0dFVCcsCiAgICAgICAgaGVhZGVyczogewogICAgICAgICAgJ2FwaWtleSc6IGRhdGEuc2VydmljZUtleSwKICAgICAgICAgICdBdXRob3JpemF0aW9uJzogYEJlYXJlciAke2RhdGEuc2VydmljZUtleX1gLAogICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJywKICAgICAgICAgICdQcmVmZXInOiAncmV0dXJuPXJlcHJlc2VudGF0aW9uJwogICAgICAgIH0KICAgICAgfQogICAgKTsKICAgIAogICAgY29uc29sZS5sb2coJ1Jlc3BvbnNlIHN0YXR1czonLCBhY3Rpdml0aWVzUmVzcG9uc2Uuc3RhdHVzKTsKICAgIAogICAgaWYgKCFhY3Rpdml0aWVzUmVzcG9uc2Uub2spIHsKICAgICAgY29uc3QgZXJyb3JUZXh0ID0gYXdhaXQgYWN0aXZpdGllc1Jlc3BvbnNlLnRleHQoKTsKICAgICAgY29uc29sZS5lcnJvcignQVBJIEVycm9yOicsIGVycm9yVGV4dCk7CiAgICAgIHRocm93IG5ldyBFcnJvcihgQVBJIEVycm9yICgke2FjdGl2aXRpZXNSZXNwb25zZS5zdGF0dXN9KTogJHtlcnJvclRleHR9YCk7CiAgICB9CiAgICAKICAgIGNvbnN0IGFjdGl2aXRpZXMgPSBhd2FpdCBhY3Rpdml0aWVzUmVzcG9uc2UuanNvbigpOwogICAgY29uc29sZS5sb2coJ0ZldGNoZWQgYWN0aXZpdGllczonLCBhY3Rpdml0aWVzLmxlbmd0aCk7
echo CiAgICAKICAgIC8vIEdldCB1bmlxdWUgbWFjaGluZXMgZnJvbSByZWNlbnQgYWN0aXZpdGllcwogICAgY29uc3QgbWFjaGluZU5hbWVzID0gWy4uLm5ldyBTZXQoYWN0aXZpdGllcy5tYXAoYSA9PiBhLm1hY2hpbmUpLmZpbHRlcihCb29sZWFuKSldOwogICAgCiAgICAvLyBEZXRlcm1pbmUgY3VycmVudCBwcm9qZWN0IChtb3N0IHJlY2VudCBhY3Rpdml0eSkKICAgIGNvbnN0IGN1cnJlbnRQcm9qZWN0ID0gYWN0aXZpdGllcy5sZW5ndGggPiAwID8gYWN0aXZpdGllc1swXS5wcm9qZWN0X25hbWUgOiBudWxsOwogICAgCiAgICAvLyBVcGRhdGUgc3RhdGUKICAgIGN1cnJlbnRGbG93U3RhdGUgPSB7CiAgICAgIGFjdGl2aXRpZXM6IGFjdGl2aXRpZXMuc2xpY2UoMCwgMTApLCAvLyBLZWVwIGxhc3QgMTAgYWN0aXZpdGllcwogICAgICBtYWNoaW5lczogbWFjaGluZU5hbWVzLAogICAgICBjdXJyZW50UHJvamVjdDogY3VycmVudFByb2plY3QsCiAgICAgIGxhc3RVcGRhdGVkOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksCiAgICAgIGVycm9yOiBudWxsCiAgICB9OwogICAgCiAgICAvLyBVcGRhdGUgYmFkZ2UKICAgIHVwZGF0ZUJhZGdlKGN1cnJlbnRQcm9qZWN0KTsKICAgIAogICAgLy8gU3RvcmUgaW4gbG9jYWwgc3RvcmFnZSBmb3IgcG9wdXAKICAgIGNocm9tZS5zdG9yYWdlLmxvY2FsLnNldCh7IGN1cnJlbnRGbG93U3RhdGUgfSk7CiAgICAKICAgIGNvbnNvbGUubG9nKCdGbG93U3RhdGUgdXBkYXRlZCBzdWNjZXNz
echo ZnVsbHknKTsKICAgIAogIH0gY2F0Y2ggKGVycm9yKSB7CiAgICBjb25zb2xlLmVycm9yKCdFcnJvciBmZXRjaGluZyBGbG93U3RhdGU6JywgZXJyb3IpOwogICAgY3VycmVudEZsb3dTdGF0ZSA9IHsKICAgICAgLi4uY3VycmVudEZsb3dTdGF0ZSwKICAgICAgZXJyb3I6IGVycm9yLm1lc3NhZ2UsCiAgICAgIGxhc3RVcGRhdGVkOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkKICAgIH07CiAgICBjaHJvbWUuc3RvcmFnZS5sb2NhbC5zZXQoeyBjdXJyZW50Rmxvd1N0YXRlIH0pOwogICAgdXBkYXRlQmFkZ2UoJyEnKTsKICB9Cn0KCi8vIFVwZGF0ZSBleHRlbnNpb24gYmFkZ2UKZnVuY3Rpb24gdXBkYXRlQmFkZ2UocHJvamVjdCkgewogIGlmICghcHJvamVjdCkgewogICAgY2hyb21lLmFjdGlvbi5zZXRCYWRnZVRleHQoeyB0ZXh0OiAnJyB9KTsKICAgIHJldHVybjsKICB9CiAgCiAgaWYgKHByb2plY3QgPT09ICchJykgewogICAgLy8gRXJyb3Igc3RhdGUKICAgIGNocm9tZS5hY3Rpb24uc2V0QmFkZ2VUZXh0KHsgdGV4dDogJyEnIH0pOwogICAgY2hyb21lLmFjdGlvbi5zZXRCYWRnZUJhY2tncm91bmRDb2xvcih7IGNvbG9yOiAnI0Y0NDMzNicgfSk7CiAgICByZXR1cm47CiAgfQogIAogIC8vIFNob3cgYWJicmV2aWF0ZWQgcHJvamVjdCBuYW1lCiAgY29uc3QgYmFkZ2UgPSBwcm9qZWN0LnN1YnN0cmluZygwLCAyKS50b1VwcGVyQ2FzZSgpOwogIGNocm9tZS5hY3Rpb24uc2V0QmFkZ2VUZXh0KHsgdGV4dDogYmFkZ2Ug
echo fSk7CiAgY2hyb21lLmFjdGlvbi5zZXRCYWRnZUJhY2tncm91bmRDb2xvcih7IGNvbG9yOiAnIzIxOTZGMycgfSk7Cn0KCi8vIE1lc3NhZ2UgaGFuZGxlciBmb3IgcG9wdXAKY2hyb21lLnJ1bnRpbWUub25NZXNzYWdlLmFkZExpc3RlbmVyKChyZXF1ZXN0LCBzZW5kZXIsIHNlbmRSZXNwb25zZSkgPT4gewogIGNvbnNvbGUubG9nKCdSZWNlaXZlZCBtZXNzYWdlOicsIHJlcXVlc3QuYWN0aW9uKTsKICAKICBpZiAocmVxdWVzdC5hY3Rpb24gPT09ICdnZXRGbG93U3RhdGUnKSB7CiAgICBjaHJvbWUuc3RvcmFnZS5sb2NhbC5nZXQoWydjdXJyZW50Rmxvd1N0YXRlJ10sIChkYXRhKSA9PiB7CiAgICAgIHNlbmRSZXNwb25zZShkYXRhLmN1cnJlbnRGbG93U3RhdGUgfHwgY3VycmVudEZsb3dTdGF0ZSk7CiAgICB9KTsKICAgIHJldHVybiB0cnVlOwogIH0gZWxzZSBpZiAocmVxdWVzdC5hY3Rpb24gPT09ICdyZWZyZXNoJykgewogICAgZmV0Y2hGbG93U3RhdGUoKS50aGVuKCgpID0+IHsKICAgICAgY2hyb21lLnN0b3JhZ2UubG9jYWwuZ2V0KFsnY3VycmVudEZsb3dTdGF0ZSddLCAoZGF0YSkgPT4gewogICAgICAgIHNlbmRSZXNwb25zZShkYXRhLmN1cnJlbnRGbG93U3RhdGUgfHwgY3VycmVudEZsb3dTdGF0ZSk7CiAgICAgIH0pOwogICAgfSk7CiAgICByZXR1cm4gdHJ1ZTsgLy8gS2VlcCBjaGFubmVsIG9wZW4gZm9yIGFzeW5jIHJlc3BvbnNlCiAgfSBlbHNlIGlmIChyZXF1ZXN0LmFjdGlvbiA9PT0gJ29wZW5EYXNoYm9h
echo cmQnKSB7CiAgICBjaHJvbWUudGFicy5jcmVhdGUoeyB1cmw6ICdodHRwczovL2Zsb3dzdGF0ZS5uZW90b2Rhay5jb20nIH0pOwogIH0gZWxzZSBpZiAocmVxdWVzdC5hY3Rpb24gPT09ICd0ZXN0Q29ubmVjdGlvbicpIHsKICAgIC8vIFRlc3QgdGhlIHNlcnZpY2Uga2V5CiAgICB0ZXN0U2VydmljZUtleShyZXF1ZXN0LnNlcnZpY2VLZXkpLnRoZW4ocmVzdWx0ID0+IHsKICAgICAgc2VuZFJlc3BvbnNlKHJlc3VsdCk7CiAgICB9KTsKICAgIHJldHVybiB0cnVlOwogIH0KfSk7CgovLyBUZXN0IHNlcnZpY2Uga2V5IGZ1bmN0aW9uCmFzeW5jIGZ1bmN0aW9uIHRlc3RTZXJ2aWNlS2V5KHNlcnZpY2VLZXkpIHsKICB0cnkgewogICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaCgKICAgICAgYCR7U1VQQUJBU0VfVVJMfS9yZXN0L3YxL2Zsb3dzdGF0ZV9hY3Rpdml0aWVzP2xpbWl0PTFgLAogICAgICB7CiAgICAgICAgbWV0aG9kOiAnR0VUJywKICAgICAgICBoZWFkZXJzOiB7CiAgICAgICAgICAnYXBpa2V5Jzogc2VydmljZUtleSwKICAgICAgICAgICdBdXRob3JpemF0aW9uJzogYEJlYXJlciAke3NlcnZpY2VLZXl9YCwKICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicKICAgICAgICB9CiAgICAgIH0KICAgICk7CiAgICAKICAgIGlmIChyZXNwb25zZS5vaykgewogICAgICByZXR1cm4geyBzdWNjZXNzOiB0cnVlLCBtZXNzYWdlOiAnQ29ubmVjdGlvbiBzdWNjZXNzZnVsIScgfTsKICAg
echo IH0gZWxzZSB7CiAgICAgIGNvbnN0IGVycm9yID0gYXdhaXQgcmVzcG9uc2UudGV4dCgpOwogICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgbWVzc2FnZTogYEVycm9yICR7cmVzcG9uc2Uuc3RhdHVzfTogJHtlcnJvcn1gIH07CiAgICB9CiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCBtZXNzYWdlOiBgQ29ubmVjdGlvbiBmYWlsZWQ6ICR7ZXJyb3IubWVzc2FnZX1gIH07CiAgfQp9
) > "%EXTENSION_DIR%\background.js.b64"
certutil -decode "%EXTENSION_DIR%\background.js.b64" "%EXTENSION_DIR%\background.js" >nul
del "%EXTENSION_DIR%\background.js.b64"

echo Creating popup.html...
(
echo PCFET0NUWVBFIGh0bWw+CjxodG1sPgo8aGVhZD4KICAgIDxtZXRhIGNoYXJzZXQ9IlVURi04Ij4KICAgIDxzdHlsZT4KICAgICAgICBib2R5IHsKICAgICAgICAgICAgd2lkdGg6IDM1MHB4OwogICAgICAgICAgICBwYWRkaW5nOiAxNXB4OwogICAgICAgICAgICBmb250LWZhbWlseTogLWFwcGxlLXN5c3RlbSwgQmxpbmtNYWNTeXN0ZW1Gb250LCAnU2Vnb2UgVUknLCBzYW5zLXNlcmlmOwogICAgICAgICAgICBtYXJnaW46IDA7CiAgICAgICAgICAgIGJhY2tncm91bmQ6ICNmNWY1ZjU7CiAgICAgICAgfQogICAgICAgIC5oZWFkZXIgewogICAgICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgICAgICBqdXN0aWZ5LWNvbnRlbnQ6IHNwYWNlLWJldHdlZW47CiAgICAgICAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICAgICAgICAgIG1hcmdpbi1ib3R0b206IDE1cHg7CiAgICAgICAgfQogICAgICAgIGgyIHsKICAgICAgICAgICAgbWFyZ2luOiAwOwogICAgICAgICAgICBjb2xvcjogIzIxOTZGMzsKICAgICAgICAgICAgZm9udC1zaXplOiAxOHB4OwogICAgICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgICAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgICAgICAgICBnYXA6IDhweDsKICAgICAgICB9CiAgICAgICAgLnJlZnJlc2gtYnRuIHsKICAgICAgICAgICAgYmFja2dyb3VuZDogbm9uZTsKICAgICAgICAgICAgYm9yZGVyOiBub25lOwogICAgICAgICAgICBjb2xvcjogIzIxOTZGMzsKICAgICAg
echo ICAgICAgY3Vyc29yOiBwb2ludGVyOwogICAgICAgICAgICBmb250LXNpemU6IDIwcHg7CiAgICAgICAgICAgIHBhZGRpbmc6IDVweDsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogNHB4OwogICAgICAgICAgICB0cmFuc2l0aW9uOiBiYWNrZ3JvdW5kIDAuMnM7CiAgICAgICAgfQogICAgICAgIC5yZWZyZXNoLWJ0bjpob3ZlciB7CiAgICAgICAgICAgIGJhY2tncm91bmQ6IHJnYmEoMzMsIDE1MCwgMjQzLCAwLjEpOwogICAgICAgIH0KICAgICAgICAucmVmcmVzaC1idG4uc3Bpbm5pbmcgewogICAgICAgICAgICBhbmltYXRpb246IHNwaW4gMXMgbGluZWFyIGluZmluaXRlOwogICAgICAgIH0KICAgICAgICBAa2V5ZnJhbWVzIHNwaW4gewogICAgICAgICAgICBmcm9tIHsgdHJhbnNmb3JtOiByb3RhdGUoMGRlZyk7IH0KICAgICAgICAgICAgdG8geyB0cmFuc2Zvcm06IHJvdGF0ZSgzNjBkZWcpOyB9CiAgICAgICAgfQogICAgICAgIC5jdXJyZW50LXN0YXR1cyB7CiAgICAgICAgICAgIGJhY2tncm91bmQ6IHdoaXRlOwogICAgICAgICAgICBwYWRkaW5nOiAxNXB4OwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiA4cHg7CiAgICAgICAgICAgIG1hcmdpbi1ib3R0b206IDE1cHg7CiAgICAgICAgICAgIGJveC1zaGFkb3c6IDAgMnB4IDRweCByZ2JhKDAsMCwwLDAuMSk7CiAgICAgICAgfQogICAgICAgIC5wcm9qZWN0LW5hbWUgewogICAgICAgICAgICBmb250LXNpemU6IDIwcHg7CiAgICAgICAgICAgIGZvbnQtd2Vp
echo Z2h0OiBib2xkOwogICAgICAgICAgICBjb2xvcjogIzMzMzsKICAgICAgICAgICAgbWFyZ2luLWJvdHRvbTogNXB4OwogICAgICAgIH0KICAgICAgICAuc3RhdHVzLW1ldGEgewogICAgICAgICAgICBmb250LXNpemU6IDEycHg7CiAgICAgICAgICAgIGNvbG9yOiAjNjY2OwogICAgICAgIH0KICAgICAgICAuYWN0aXZpdGllcyB7CiAgICAgICAgICAgIGJhY2tncm91bmQ6IHdoaXRlOwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiA4cHg7CiAgICAgICAgICAgIHBhZGRpbmc6IDEwcHggMDsKICAgICAgICAgICAgYm94LXNoYWRvdzogMCAycHggNHB4IHJnYmEoMCwwLDAsMC4xKTsKICAgICAgICAgICAgbWF4LWhlaWdodDogMzAwcHg7CiAgICAgICAgICAgIG92ZXJmbG93LXk6IGF1dG87CiAgICAgICAgfQogICAgICAgIC5hY3Rpdml0eS1pdGVtIHsKICAgICAgICAgICAgcGFkZGluZzogMTBweCAxNXB4OwogICAgICAgICAgICBib3JkZXItYm90dG9tOiAxcHggc29saWQgI2VlZTsKICAgICAgICAgICAgdHJhbnNpdGlvbjogYmFja2dyb3VuZCAwLjJzOwogICAgICAgIH0KICAgICAgICAuYWN0aXZpdHktaXRlbTpsYXN0LWNoaWxkIHsKICAgICAgICAgICAgYm9yZGVyLWJvdHRvbTogbm9uZTsKICAgICAgICB9CiAgICAgICAgLmFjdGl2aXR5LWl0ZW06aG92ZXIgewogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjZjhmOWZhOwogICAgICAgIH0KICAgICAgICAuYWN0aXZpdHktaGVhZGVyIHsKICAgICAgICAgICAgZGlzcGxh
echo eTogZmxleDsKICAgICAgICAgICAganVzdGlmeS1jb250ZW50OiBzcGFjZS1iZXR3ZWVuOwogICAgICAgICAgICBhbGlnbi1pdGVtczogZmxleC1zdGFydDsKICAgICAgICAgICAgbWFyZ2luLWJvdHRvbTogNHB4OwogICAgICAgIH0KICAgICAgICAuYWN0aXZpdHktcHJvamVjdCB7CiAgICAgICAgICAgIGZvbnQtd2VpZ2h0OiA2MDA7CiAgICAgICAgICAgIGNvbG9yOiAjMjE5NkYzOwogICAgICAgICAgICBmb250LXNpemU6IDE0cHg7CiAgICAgICAgfQogICAgICAgIC5hY3Rpdml0eS10aW1lIHsKICAgICAgICAgICAgZm9udC1zaXplOiAxMXB4OwogICAgICAgICAgICBjb2xvcjogIzk5OTsKICAgICAgICB9CiAgICAgICAgLmFjdGl2aXR5LWRlc2NyaXB0aW9uIHsKICAgICAgICAgICAgZm9udC1zaXplOiAxM3B4OwogICAgICAgICAgICBjb2xvcjogIzU1NTsKICAgICAgICAgICAgbWFyZ2luLWJvdHRvbTogNHB4OwogICAgICAgIH0KICAgICAgICAuYWN0aXZpdHktbWFjaGluZSB7CiAgICAgICAgICAgIGZvbnQtc2l6ZTogMTFweDsKICAgICAgICAgICAgY29sb3I6ICM4ODg7CiAgICAgICAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgICAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICAgICAgICAgIGdhcDogNHB4OwogICAgICAgIH0KICAgICAgICAubWFjaGluZS1pY29uIHsKICAgICAgICAgICAgZm9udC1zaXplOiAxMnB4OwogICAgICAgIH0KICAgICAgICAubm8tYWN0aXZpdGllcyB7CiAgICAgICAgICAgIHRl
echo eHQtYWxpZ246IGNlbnRlcjsKICAgICAgICAgICAgcGFkZGluZzogNDBweCAyMHB4OwogICAgICAgICAgICBjb2xvcjogIzk5OTsKICAgICAgICB9CiAgICAgICAgLnNldHRpbmdzIHsKICAgICAgICAgICAgbWFyZ2luLXRvcDogMTVweDsKICAgICAgICAgICAgcGFkZGluZy10b3A6IDE1cHg7CiAgICAgICAgICAgIGJvcmRlci10b3A6IDFweCBzb2xpZCAjZGRkOwogICAgICAgIH0KICAgICAgICAuc2V0dGluZ3Mtcm93IHsKICAgICAgICAgICAgZGlzcGxheTogZmxleDsKICAgICAgICAgICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgICAgICAgICAganVzdGlmeS1jb250ZW50OiBzcGFjZS1iZXR3ZWVuOwogICAgICAgICAgICBtYXJnaW4tYm90dG9tOiAxMHB4OwogICAgICAgIH0KICAgICAgICBpbnB1dFt0eXBlPSJwYXNzd29yZCJdIHsKICAgICAgICAgICAgd2lkdGg6IDEwMCU7CiAgICAgICAgICAgIHBhZGRpbmc6IDhweDsKICAgICAgICAgICAgYm9yZGVyOiAxcHggc29saWQgI2RkZDsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogNHB4OwogICAgICAgICAgICBtYXJnaW4tYm90dG9tOiAxMHB4OwogICAgICAgICAgICBib3gtc2l6aW5nOiBib3JkZXItYm94OwogICAgICAgIH0KICAgICAgICBidXR0b24gewogICAgICAgICAgICB3aWR0aDogMTAwJTsKICAgICAgICAgICAgcGFkZGluZzogMTBweDsKICAgICAgICAgICAgYm9yZGVyOiBub25lOwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiA2cHg7CiAgICAg
echo ICAgICAgIGJhY2tncm91bmQ6ICMyMTk2RjM7CiAgICAgICAgICAgIGNvbG9yOiB3aGl0ZTsKICAgICAgICAgICAgY3Vyc29yOiBwb2ludGVyOwogICAgICAgICAgICBtYXJnaW4tYm90dG9tOiAxMHB4OwogICAgICAgICAgICBmb250LXNpemU6IDE0cHg7CiAgICAgICAgfQogICAgICAgIGJ1dHRvbjpob3ZlciB7CiAgICAgICAgICAgIGJhY2tncm91bmQ6ICMxOTc2RDI7CiAgICAgICAgfQogICAgICAgIGJ1dHRvbi5zZWNvbmRhcnkgewogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjZmZmOwogICAgICAgICAgICBjb2xvcjogIzIxOTZGMzsKICAgICAgICAgICAgYm9yZGVyOiAxcHggc29saWQgIzIxOTZGMzsKICAgICAgICB9CiAgICAgICAgYnV0dG9uLnNlY29uZGFyeTpob3ZlciB7CiAgICAgICAgICAgIGJhY2tncm91bmQ6ICNmNWY1ZjU7CiAgICAgICAgfQogICAgICAgIC50b2dnbGUgewogICAgICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgICAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgICAgICAgICBqdXN0aWZ5LWNvbnRlbnQ6IHNwYWNlLWJldHdlZW47CiAgICAgICAgfQogICAgICAgIC5zd2l0Y2ggewogICAgICAgICAgICBwb3NpdGlvbjogcmVsYXRpdmU7CiAgICAgICAgICAgIHdpZHRoOiA0MHB4OwogICAgICAgICAgICBoZWlnaHQ6IDIwcHg7CiAgICAgICAgfQogICAgICAgIC5zd2l0Y2ggaW5wdXQgewogICAgICAgICAgICBvcGFjaXR5OiAwOwogICAgICAgICAgICB3aWR0aDogMDsKICAgICAg
echo ICAgICAgaGVpZ2h0OiAwOwogICAgICAgIH0KICAgICAgICAuc2xpZGVyIHsKICAgICAgICAgICAgcG9zaXRpb246IGFic29sdXRlOwogICAgICAgICAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICAgICAgICAgIHRvcDogMDsKICAgICAgICAgICAgbGVmdDogMDsKICAgICAgICAgICAgcmlnaHQ6IDA7CiAgICAgICAgICAgIGJvdHRvbTogMDsKICAgICAgICAgICAgYmFja2dyb3VuZC1jb2xvcjogI2NjYzsKICAgICAgICAgICAgdHJhbnNpdGlvbjogLjRzOwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiAyMHB4OwogICAgICAgIH0KICAgICAgICAuc2xpZGVyOmJlZm9yZSB7CiAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgICAgICAgICAgY29udGVudDogIiI7CiAgICAgICAgICAgIGhlaWdodDogMTRweDsKICAgICAgICAgICAgd2lkdGg6IDE0cHg7CiAgICAgICAgICAgIGxlZnQ6IDNweDsKICAgICAgICAgICAgYm90dG9tOiAzcHg7CiAgICAgICAgICAgIGJhY2tncm91bmQtY29sb3I6IHdoaXRlOwogICAgICAgICAgICB0cmFuc2l0aW9uOiAuNHM7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgICAgICB9CiAgICAgICAgaW5wdXQ6Y2hlY2tlZCArIC5zbGlkZXIgewogICAgICAgICAgICBiYWNrZ3JvdW5kLWNvbG9yOiAjMjE5NkYzOwogICAgICAgIH0KICAgICAgICBpbnB1dDpjaGVja2VkICsgLnNsaWRlcjpiZWZvcmUgewogICAgICAgICAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoMjBw
echo eCk7CiAgICAgICAgfQogICAgICAgIC5sb2FkaW5nIHsKICAgICAgICAgICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgICAgICAgICBwYWRkaW5nOiA0MHB4OwogICAgICAgICAgICBjb2xvcjogIzY2NjsKICAgICAgICB9CiAgICAgICAgLmVycm9yIHsKICAgICAgICAgICAgYmFja2dyb3VuZDogI2ZmZWJlZTsKICAgICAgICAgICAgY29sb3I6ICNjNjI4Mjg7CiAgICAgICAgICAgIHBhZGRpbmc6IDEwcHg7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDRweDsKICAgICAgICAgICAgbWFyZ2luLWJvdHRvbTogMTBweDsKICAgICAgICAgICAgZm9udC1zaXplOiAxM3B4OwogICAgICAgIH0KICAgIDwvc3R5bGU+CjwvaGVhZD4KPGJvZHk+CiAgICA8ZGl2IGNsYXNzPSJoZWFkZXIiPgogICAgICAgIDxoMj7wn4yKIEZsb3dTdGF0ZSBWaWV3ZXI8L2gyPgogICAgICAgIDxidXR0b24gY2xhc3M9InJlZnJlc2gtYnRuIiBpZD0icmVmcmVzaEJ0biIgdGl0bGU9IlJlZnJlc2giPuKGuzwvYnV0dG9uPgogICAgPC9kaXY+CiAgICAKICAgIDxkaXYgaWQ9Im1haW5Db250ZW50Ij4KICAgICAgICA8ZGl2IGNsYXNzPSJsb2FkaW5nIj5Mb2FkaW5nIEZsb3dTdGF0ZS4uLjwvZGl2PgogICAgPC9kaXY+CiAgICAKICAgIDxkaXYgY2xhc3M9InNldHRpbmdzIj4KICAgICAgICA8ZGl2IGNsYXNzPSJ0b2dnbGUiPgogICAgICAgICAgICA8c3Bhbj5BdXRvLXJlZnJlc2g8L3NwYW4+CiAgICAgICAgICAgIDxsYWJlbCBjbGFzcz0ic3dpdGNo
echo Ij4KICAgICAgICAgICAgICAgIDxpbnB1dCB0eXBlPSJjaGVja2JveCIgaWQ9ImVuYWJsZVRvZ2dsZSIgY2hlY2tlZD4KICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJzbGlkZXIiPjwvc3Bhbj4KICAgICAgICAgICAgPC9sYWJlbD4KICAgICAgICA8L2Rpdj4KICAgICAgICAKICAgICAgICA8aW5wdXQgdHlwZT0icGFzc3dvcmQiIGlkPSJzZXJ2aWNlS2V5IiBwbGFjZWhvbGRlcj0iU3VwYWJhc2UgU2VydmljZSBLZXkiPgogICAgICAgIDxidXR0b24gaWQ9InNhdmVCdG4iPlNhdmUgU2V0dGluZ3M8L2J1dHRvbj4KICAgICAgICA8YnV0dG9uIGlkPSJkYXNoYm9hcmRCdG4iIGNsYXNzPSJzZWNvbmRhcnkiPk9wZW4gRGFzaGJvYXJkIOKGkjwvYnV0dG9uPgogICAgPC9kaXY+CiAgICAKICAgIDxzY3JpcHQgc3JjPSJwb3B1cC5qcyI+PC9zY3JpcHQ+CjwvYm9keT4KPC9odG1sPg==
) > "%EXTENSION_DIR%\popup.html.b64"
certutil -decode "%EXTENSION_DIR%\popup.html.b64" "%EXTENSION_DIR%\popup.html" >nul
del "%EXTENSION_DIR%\popup.html.b64"

echo Creating popup.js...
(
echo Ly8gRmxvd1N0YXRlIEJyb3dzZXIgRXh0ZW5zaW9uIC0gUG9wdXAgU2NyaXB0Cgpkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdET01Db250ZW50TG9hZGVkJywgYXN5bmMgKCkgPT4gewogICAgLy8gTG9hZCBzYXZlZCBzZXR0aW5ncwogICAgY29uc3Qgc2V0dGluZ3MgPSBhd2FpdCBjaHJvbWUuc3RvcmFnZS5sb2NhbC5nZXQoWydzZXJ2aWNlS2V5JywgJ2VuYWJsZWQnXSk7CiAgICAKICAgIGlmIChzZXR0aW5ncy5zZXJ2aWNlS2V5KSB7CiAgICAgICAgLy8gSGlkZSBzZXJ2aWNlIGtleSBpbnB1dCBhbmQgc2hvdyBjb25maWd1cmVkIHN0YXRlCiAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NlcnZpY2VLZXknKS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgIGNvbnN0IHNhdmVCdG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2F2ZUJ0bicpOwogICAgICAgIHNhdmVCdG4udGV4dENvbnRlbnQgPSAnUmVjb25maWd1cmUnOwogICAgICAgIHNhdmVCdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7CiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzZXJ2aWNlS2V5Jykuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzZXJ2aWNlS2V5JykudmFsdWUgPSAnJzsKICAgICAgICAgICAgc2F2ZUJ0bi50ZXh0Q29udGVudCA9ICdTYXZlIFNldHRpbmdzJzsKICAgICAgICB9KTsKICAgIH0KICAgIAogICAg
echo aWYgKHNldHRpbmdzLmVuYWJsZWQgIT09IHVuZGVmaW5lZCkgewogICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdlbmFibGVUb2dnbGUnKS5jaGVja2VkID0gc2V0dGluZ3MuZW5hYmxlZDsKICAgIH0KICAgIAogICAgLy8gSW5pdGlhbCBkaXNwbGF5CiAgICBkaXNwbGF5Rmxvd1N0YXRlKCk7CiAgICAKICAgIC8vIEJ1dHRvbiBoYW5kbGVycwogICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3JlZnJlc2hCdG4nKS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGFzeW5jICgpID0+IHsKICAgICAgICBjb25zdCBidG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmVmcmVzaEJ0bicpOwogICAgICAgIGJ0bi5jbGFzc0xpc3QuYWRkKCdzcGlubmluZycpOwogICAgICAgIAogICAgICAgIGNocm9tZS5ydW50aW1lLnNlbmRNZXNzYWdlKHsgYWN0aW9uOiAncmVmcmVzaCcgfSwgKHJlc3BvbnNlKSA9PiB7CiAgICAgICAgICAgIGRpc3BsYXlGbG93U3RhdGUoKTsKICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiBidG4uY2xhc3NMaXN0LnJlbW92ZSgnc3Bpbm5pbmcnKSwgNTAwKTsKICAgICAgICB9KTsKICAgIH0pOwogICAgCiAgICBjb25zdCBzYXZlQnRuSGFuZGxlciA9IGFzeW5jICgpID0+IHsKICAgICAgICBjb25zdCBzZXJ2aWNlS2V5ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NlcnZpY2VLZXknKS52YWx1ZS50cmltKCk7CiAgICAgICAgY29uc3QgZW5hYmxlZCA9IGRvY3VtZW50LmdldEVsZW1l
echo bnRCeUlkKCdlbmFibGVUb2dnbGUnKS5jaGVja2VkOwogICAgICAgIAogICAgICAgIGlmICghc2VydmljZUtleSkgewogICAgICAgICAgICBzaG93RXJyb3IoJ1BsZWFzZSBlbnRlciBhIHNlcnZpY2Uga2V5Jyk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLy8gVGVzdCB0aGUgY29ubmVjdGlvbiBmaXJzdAogICAgICAgIHNob3dTdGF0dXMoJ1Rlc3RpbmcgY29ubmVjdGlvbi4uLicpOwogICAgICAgIGNocm9tZS5ydW50aW1lLnNlbmRNZXNzYWdlKHsgCiAgICAgICAgICAgIGFjdGlvbjogJ3Rlc3RDb25uZWN0aW9uJywgCiAgICAgICAgICAgIHNlcnZpY2VLZXk6IHNlcnZpY2VLZXkgCiAgICAgICAgfSwgYXN5bmMgKHJlc3VsdCkgPT4gewogICAgICAgICAgICBpZiAocmVzdWx0LnN1Y2Nlc3MpIHsKICAgICAgICAgICAgICAgIC8vIFNhdmUgc2V0dGluZ3MKICAgICAgICAgICAgICAgIGF3YWl0IGNocm9tZS5zdG9yYWdlLmxvY2FsLnNldCh7IHNlcnZpY2VLZXksIGVuYWJsZWQgfSk7CiAgICAgICAgICAgICAgICBzaG93U3RhdHVzKCdTZXR0aW5ncyBzYXZlZCEnKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gSGlkZSB0aGUgc2VydmljZSBrZXkgZmllbGQKICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzZXJ2aWNlS2V5Jykuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgICAgIGNvbnN0IHNhdmVCdG4gPSBkb2N1
echo bWVudC5nZXRFbGVtZW50QnlJZCgnc2F2ZUJ0bicpOwogICAgICAgICAgICAgICAgc2F2ZUJ0bi50ZXh0Q29udGVudCA9ICdSZWNvbmZpZ3VyZSc7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJlbW92ZSBvbGQgaGFuZGxlciBhbmQgYWRkIG5ldyBvbmUKICAgICAgICAgICAgICAgIHNhdmVCdG4ucmVtb3ZlRXZlbnRMaXN0ZW5lcignY2xpY2snLCBzYXZlQnRuSGFuZGxlcik7CiAgICAgICAgICAgICAgICBzYXZlQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4gewogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzZXJ2aWNlS2V5Jykuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NlcnZpY2VLZXknKS52YWx1ZSA9ICcnOwogICAgICAgICAgICAgICAgICAgIHNhdmVCdG4udGV4dENvbnRlbnQgPSAnU2F2ZSBTZXR0aW5ncyc7CiAgICAgICAgICAgICAgICAgICAgc2F2ZUJ0bi5yZW1vdmVFdmVudExpc3RlbmVyKCdjbGljaycsIGFyZ3VtZW50cy5jYWxsZWUpOwogICAgICAgICAgICAgICAgICAgIHNhdmVCdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBzYXZlQnRuSGFuZGxlcik7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVHJpZ2dlciByZWZyZXNoCiAgICAgICAgICAgICAgICBjaHJvbWUucnVudGltZS5zZW5k
echo TWVzc2FnZSh7IGFjdGlvbjogJ3JlZnJlc2gnIH0sICgpID0+IHsKICAgICAgICAgICAgICAgICAgICBkaXNwbGF5Rmxvd1N0YXRlKCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHNob3dFcnJvcihyZXN1bHQubWVzc2FnZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH07CiAgICAKICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzYXZlQnRuJykuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBzYXZlQnRuSGFuZGxlcik7CiAgICAKICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdlbmFibGVUb2dnbGUnKS5hZGRFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCBhc3luYyAoZSkgPT4gewogICAgICAgIGF3YWl0IGNocm9tZS5zdG9yYWdlLmxvY2FsLnNldCh7IGVuYWJsZWQ6IGUudGFyZ2V0LmNoZWNrZWQgfSk7CiAgICAgICAgaWYgKGUudGFyZ2V0LmNoZWNrZWQpIHsKICAgICAgICAgICAgY2hyb21lLnJ1bnRpbWUuc2VuZE1lc3NhZ2UoeyBhY3Rpb246ICdyZWZyZXNoJyB9KTsKICAgICAgICB9CiAgICB9KTsKICAgIAogICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2Rhc2hib2FyZEJ0bicpLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4gewogICAgICAgIGNocm9tZS5ydW50aW1lLnNlbmRNZXNzYWdlKHsgYWN0aW9uOiAnb3BlbkRhc2hib2FyZCcgfSk7CiAgICB9KTsKfSk7CgpmdW5jdGlvbiBkaXNwbGF5Rmxvd1N0YXRlKCkgewog
echo ICAgY2hyb21lLnJ1bnRpbWUuc2VuZE1lc3NhZ2UoeyBhY3Rpb246ICdnZXRGbG93U3RhdGUnIH0sIChmbG93U3RhdGUpID0+IHsKICAgICAgICBjb25zdCBjb250ZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21haW5Db250ZW50Jyk7CiAgICAgICAgCiAgICAgICAgLy8gSGFuZGxlIGVycm9ycwogICAgICAgIGlmIChmbG93U3RhdGUgJiYgZmxvd1N0YXRlLmVycm9yKSB7CiAgICAgICAgICAgIGNvbnRlbnQuaW5uZXJIVE1MID0gYAogICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iZXJyb3IiPgogICAgICAgICAgICAgICAgICAgIDxzdHJvbmc+RXJyb3I6PC9zdHJvbmc+ICR7ZXNjYXBlSHRtbChmbG93U3RhdGUuZXJyb3IpfQogICAgICAgICAgICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi10b3A6IDEwcHg7IGZvbnQtc2l6ZTogMTJweDsiPgogICAgICAgICAgICAgICAgICAgICAgICA8YSBocmVmPSIjIiBpZD0iY29uc29sZUxpbmsiIHN0eWxlPSJjb2xvcjogaW5oZXJpdDsiPlZpZXcgY29uc29sZSBmb3IgZGV0YWlsczwvYT4KICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICBgOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGlmICghZmxvd1N0YXRlIHx8ICFmbG93U3RhdGUuYWN0aXZpdGllcyB8fCBmbG93U3RhdGUuYWN0aXZpdGllcy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgY29udGVudC5p
echo bm5lckhUTUwgPSBgCiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJuby1hY3Rpdml0aWVzIj4KICAgICAgICAgICAgICAgICAgICA8cD5ObyByZWNlbnQgYWN0aXZpdGllczwvcD4KICAgICAgICAgICAgICAgICAgICA8cCBzdHlsZT0iZm9udC1zaXplOiAxMnB4OyBtYXJnaW4tdG9wOiAxMHB4OyI+CiAgICAgICAgICAgICAgICAgICAgICAgICR7Zmxvd1N0YXRlID8gJ05vIGFjdGl2aXRpZXMgaW4gdGhlIGxhc3QgMiBob3VycycgOiAnQ29uZmlndXJlIHlvdXIgc2VydmljZSBrZXkgYmVsb3cnfQogICAgICAgICAgICAgICAgICAgIDwvcD4KICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICBgOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGNvbnN0IGN1cnJlbnRBY3Rpdml0eSA9IGZsb3dTdGF0ZS5hY3Rpdml0aWVzWzBdOwogICAgICAgIGNvbnN0IHRpbWVBZ28gPSBnZXRUaW1lQWdvKG5ldyBEYXRlKGN1cnJlbnRBY3Rpdml0eS5jcmVhdGVkX2F0KSk7CiAgICAgICAgCiAgICAgICAgbGV0IGh0bWwgPSBgCiAgICAgICAgICAgIDxkaXYgY2xhc3M9ImN1cnJlbnQtc3RhdHVzIj4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InByb2plY3QtbmFtZSI+JHtlc2NhcGVIdG1sKGN1cnJlbnRBY3Rpdml0eS5wcm9qZWN0X25hbWUgfHwgJ1Vua25vd24gUHJvamVjdCcpfTwvZGl2PgogICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ic3RhdHVzLW1ldGEiPgogICAgICAg
echo ICAgICAgICAgICAgIEFjdGl2ZSAke3RpbWVBZ299IG9uICR7ZXNjYXBlSHRtbChmb3JtYXRNYWNoaW5lKGN1cnJlbnRBY3Rpdml0eS5tYWNoaW5lKSl9CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIAogICAgICAgICAgICA8aDMgc3R5bGU9Im1hcmdpbjogMCAwIDEwcHggMDsgZm9udC1zaXplOiAxNHB4OyBjb2xvcjogIzY2NjsiPlJlY2VudCBBY3Rpdml0aWVzPC9oMz4KICAgICAgICAgICAgPGRpdiBjbGFzcz0iYWN0aXZpdGllcyI+CiAgICAgICAgYDsKICAgICAgICAKICAgICAgICBmbG93U3RhdGUuYWN0aXZpdGllcy5mb3JFYWNoKGFjdGl2aXR5ID0+IHsKICAgICAgICAgICAgY29uc3QgYWN0aXZpdHlUaW1lID0gZ2V0VGltZUFnbyhuZXcgRGF0ZShhY3Rpdml0eS5jcmVhdGVkX2F0KSk7CiAgICAgICAgICAgIGNvbnN0IG1hY2hpbmVJY29uID0gZ2V0TWFjaGluZUljb24oYWN0aXZpdHkubWFjaGluZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBodG1sICs9IGAKICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImFjdGl2aXR5LWl0ZW0iPgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImFjdGl2aXR5LWhlYWRlciI+CiAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJhY3Rpdml0eS1wcm9qZWN0Ij4ke2VzY2FwZUh0bWwoYWN0aXZpdHkucHJvamVjdF9uYW1lIHx8ICdVbmtub3duJyl9PC9zcGFuPgogICAgICAgICAgICAgICAgICAg
echo ICAgICA8c3BhbiBjbGFzcz0iYWN0aXZpdHktdGltZSI+JHthY3Rpdml0eVRpbWV9PC9zcGFuPgogICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImFjdGl2aXR5LWRlc2NyaXB0aW9uIj4ke2VzY2FwZUh0bWwoYWN0aXZpdHkuYWN0aXZpdHlfZGVzY3JpcHRpb24pfTwvZGl2PgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImFjdGl2aXR5LW1hY2hpbmUiPgogICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0ibWFjaGluZS1pY29uIj4ke21hY2hpbmVJY29ufTwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4+JHtlc2NhcGVIdG1sKGZvcm1hdE1hY2hpbmUoYWN0aXZpdHkubWFjaGluZSkpfTwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICBgOwogICAgICAgIH0pOwogICAgICAgIAogICAgICAgIGh0bWwgKz0gJzwvZGl2Pic7CiAgICAgICAgCiAgICAgICAgLy8gQWRkIGxhc3QgdXBkYXRlZCB0aW1lCiAgICAgICAgaWYgKGZsb3dTdGF0ZS5sYXN0VXBkYXRlZCkgewogICAgICAgICAgICBjb25zdCBsYXN0VXBkYXRlZCA9IG5ldyBEYXRlKGZsb3dTdGF0ZS5sYXN0VXBkYXRlZCk7CiAgICAgICAgICAgIGh0bWwgKz0gYDxkaXYgc3R5bGU9InRleHQtYWxpZ246IGNlbnRlcjsgZm9udC1zaXplOiAxMXB4OyBjb2xvcjogIzk5OTsgbWFyZ2luLXRvcDogMTBw
echo eDsiPgogICAgICAgICAgICAgICAgTGFzdCB1cGRhdGVkOiAke2xhc3RVcGRhdGVkLnRvTG9jYWxlVGltZVN0cmluZygpfQogICAgICAgICAgICA8L2Rpdj5gOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBjb250ZW50LmlubmVySFRNTCA9IGh0bWw7CiAgICAgICAgCiAgICAgICAgLy8gQWRkIGV2ZW50IGxpc3RlbmVyIGZvciBjb25zb2xlIGxpbmsgaWYgaXQgZXhpc3RzCiAgICAgICAgY29uc3QgY29uc29sZUxpbmsgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY29uc29sZUxpbmsnKTsKICAgICAgICBpZiAoY29uc29sZUxpbmspIHsKICAgICAgICAgICAgY29uc29sZUxpbmsuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgY2hyb21lLnJ1bnRpbWUub3Blbk9wdGlvbnNQYWdlKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0pOwp9CgpmdW5jdGlvbiBnZXRUaW1lQWdvKGRhdGUpIHsKICAgIGNvbnN0IHNlY29uZHMgPSBNYXRoLmZsb29yKChuZXcgRGF0ZSgpIC0gZGF0ZSkgLyAxMDAwKTsKICAgIAogICAgaWYgKHNlY29uZHMgPCA2MCkgcmV0dXJuICdqdXN0IG5vdyc7CiAgICBpZiAoc2Vjb25kcyA8IDM2MDApIHJldHVybiBgJHtNYXRoLmZsb29yKHNlY29uZHMgLyA2MCl9bSBhZ29gOwogICAgaWYgKHNlY29uZHMgPCA4NjQwMCkgcmV0dXJuIGAke01hdGguZmxvb3Ioc2Vjb25kcyAvIDM2
echo MDApfWggYWdvYDsKICAgIHJldHVybiBgJHtNYXRoLmZsb29yKHNlY29uZHMgLyA4NjQwMCl9ZCBhZ29gOwp9CgpmdW5jdGlvbiBmb3JtYXRNYWNoaW5lKG1hY2hpbmUpIHsKICAgIGlmICghbWFjaGluZSkgcmV0dXJuICdVbmtub3duJzsKICAgIAogICAgLy8gU2ltcGxpZnkgbWFjaGluZSBuYW1lcwogICAgaWYgKG1hY2hpbmUuaW5jbHVkZXMoJ01hY0Jvb2snKSkgcmV0dXJuICdNYWNCb29rJzsKICAgIGlmIChtYWNoaW5lLmluY2x1ZGVzKCdDaHJvbWUgRXh0ZW5zaW9uJykpIHJldHVybiAnQnJvd3Nlcic7CiAgICBpZiAobWFjaGluZS5pbmNsdWRlcygnY2xhdWRlLWNsaScpKSByZXR1cm4gJ0NsYXVkZSBDTEknOwogICAgaWYgKG1hY2hpbmUuaW5jbHVkZXMoJ0RvY2tlcicpKSByZXR1cm4gJ0RvY2tlcic7CiAgICAKICAgIHJldHVybiBtYWNoaW5lOwp9CgpmdW5jdGlvbiBnZXRNYWNoaW5lSWNvbihtYWNoaW5lKSB7CiAgICBpZiAoIW1hY2hpbmUpIHJldHVybiAn8J+Suyc7CiAgICAKICAgIGlmIChtYWNoaW5lLmluY2x1ZGVzKCdNYWNCb29rJykpIHJldHVybiAn8J+Suyc7CiAgICBpZiAobWFjaGluZS5pbmNsdWRlcygnQ2hyb21lIEV4dGVuc2lvbicpKSByZXR1cm4gJ/CfjJAnOwogICAgaWYgKG1hY2hpbmUuaW5jbHVkZXMoJ2NsYXVkZS1jbGknKSkgcmV0dXJuICfwn6SWJzsKICAgIGlmIChtYWNoaW5lLmluY2x1ZGVzKCdEb2NrZXInKSkgcmV0dXJuICfwn5CzJzsKICAgIGlmIChtYWNoaW5lLmluY2x1ZGVzKCdH
echo aXRIdWIgQWN0aW9ucycpKSByZXR1cm4gJ+Kame+4jyc7CiAgICAKICAgIHJldHVybiAn8J+Suyc7Cn0KCmZ1bmN0aW9uIHNob3dTdGF0dXMobWVzc2FnZSkgewogICAgY29uc3QgYnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NhdmVCdG4nKTsKICAgIGNvbnN0IG9yaWdpbmFsVGV4dCA9IGJ0bi50ZXh0Q29udGVudDsKICAgIGJ0bi50ZXh0Q29udGVudCA9IG1lc3NhZ2U7CiAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICBidG4udGV4dENvbnRlbnQgPSBvcmlnaW5hbFRleHQ7CiAgICB9LCAyMDAwKTsKfQoKZnVuY3Rpb24gc2hvd0Vycm9yKG1lc3NhZ2UpIHsKICAgIGNvbnN0IGNvbnRlbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWFpbkNvbnRlbnQnKTsKICAgIGNvbnRlbnQuaW5uZXJIVE1MID0gYDxkaXYgY2xhc3M9ImVycm9yIj4ke2VzY2FwZUh0bWwobWVzc2FnZSl9PC9kaXY+YCArIGNvbnRlbnQuaW5uZXJIVE1MOwogICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgLy8gUmVtb3ZlIGVycm9yIG1lc3NhZ2UKICAgICAgICBjb25zdCBlcnJvciA9IGNvbnRlbnQucXVlcnlTZWxlY3RvcignLmVycm9yJyk7CiAgICAgICAgaWYgKGVycm9yKSBlcnJvci5yZW1vdmUoKTsKICAgIH0sIDUwMDApOwp9CgpmdW5jdGlvbiBlc2NhcGVIdG1sKHRleHQpIHsKICAgIGNvbnN0IGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgZGl2LnRleHRDb250ZW50ID0gdGV4dDsKICAg
echo IHJldHVybiBkaXYuaW5uZXJIVE1MOwp9Cgo=
) > "%EXTENSION_DIR%\popup.js.b64"
certutil -decode "%EXTENSION_DIR%\popup.js.b64" "%EXTENSION_DIR%\popup.js" >nul
del "%EXTENSION_DIR%\popup.js.b64"

echo Creating icon16.png...
(
echo iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAA7AAAAOwBeShxvQAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAABPSURBVDiN7Y4xCgAwCAN3/v+zHRxELYKD0DkItyQEQETkRkb1AaBqAS5nZ/cFmJkPgKoWYGcPzOwTwN0LsLNb/w7M7AWoun0Cd/8EZvaSDR4hKQ9nQ4ujAAAAAElFTkSuQmCC
) > "%EXTENSION_DIR%\icon16.png.b64"
certutil -decode "%EXTENSION_DIR%\icon16.png.b64" "%EXTENSION_DIR%\icon16.png" >nul
del "%EXTENSION_DIR%\icon16.png.b64"

echo Creating icon48.png...
(
echo iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAA7AAAAOwBeShxvQAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAABwSURBVGiB7dihDcAwDETRl2XJMmQZsgyZJcswTJcFSiGDolCQ/S+5Vc4nOTkiIs6mqiZ2Zna8SxERd5IkSZKkf1TV5HneAfQk7T1PE5GZ2YGYGRFBP6mqiTnndQBXkvae0TSYmR2I3gfozOwXJEl64gGhiyUhjV/PCQAAAABJRU5ErkJggg==
) > "%EXTENSION_DIR%\icon48.png.b64"
certutil -decode "%EXTENSION_DIR%\icon48.png.b64" "%EXTENSION_DIR%\icon48.png" >nul
del "%EXTENSION_DIR%\icon48.png.b64"

echo Creating icon128.png...
(
echo iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAA7AAAAOwBeShxvQAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAACXSURBVHic7duxDYAwDETRh2UsQxYiy5BlmC4LQAEUKATZeq9y5fycZEeSpL+oqsnd3V1EvCfOzKoGZmZHZGZExPshqmqCu7u7iIj3xJlZ1cDM7IjMjKn5PoADMjM6MDPb+wCOSLsPoKqmmJlddwAzs6qBu7u7iIj3xJlZ1cDM7IjMjIh4T5yaVQ3MzI7I9wFI0vAeEUUzCJdnGBsAAAAASUVORK5CYII=
) > "%EXTENSION_DIR%\icon128.png.b64"
certutil -decode "%EXTENSION_DIR%\icon128.png.b64" "%EXTENSION_DIR%\icon128.png" >nul
del "%EXTENSION_DIR%\icon128.png.b64"

exit /b