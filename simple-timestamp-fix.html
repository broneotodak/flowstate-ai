<!DOCTYPE html>
<html>
<head>
    <title>Simple Timestamp Fix</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
        }
        button {
            background: #2196f3;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px 0;
            width: 100%;
        }
        button:hover { background: #1976d2; }
        .code {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-family: monospace;
        }
        .success { color: #4caf50; }
        .error { color: #f44336; }
    </style>
</head>
<body>
    <h1>üïê Simple Timestamp Fix</h1>
    
    <p>The error "record new has no field status" suggests a database trigger issue.</p>
    
    <div class="code">
        <h3>Option 1: Run this SQL in Supabase Dashboard</h3>
        <pre>
-- Simple direct update
UPDATE current_context
SET last_updated = NOW()
WHERE user_id = 'neo_todak';
        </pre>
    </div>
    
    <input type="password" id="serviceKey" placeholder="Service Role Key">
    <button onclick="deleteAndRecreate()">Option 2: Delete & Recreate Record</button>
    
    <div id="status"></div>

    <script>
        const SUPABASE_URL = 'https://uzamamymfzhelvkwpvgt.supabase.co';
        document.getElementById('serviceKey').value = localStorage.getItem('flowstate_service_key') || '';
        
        async function deleteAndRecreate() {
            const serviceKey = document.getElementById('serviceKey').value;
            if (!serviceKey) return alert('Enter service key');
            
            const supabase = window.supabase.createClient(SUPABASE_URL, serviceKey);
            const status = document.getElementById('status');
            
            try {
                // Step 1: Delete existing record
                const { error: deleteError } = await supabase
                    .from('current_context')
                    .delete()
                    .eq('user_id', 'neo_todak');
                
                if (deleteError) {
                    console.log('Delete error (might be OK):', deleteError);
                }
                
                // Step 2: Insert fresh record with proper timestamp
                const newContext = {
                    user_id: 'neo_todak',
                    project_name: 'flowstate-ai',
                    current_task: 'Fixed timezone issue for automated tracking',
                    current_phase: 'Development',
                    progress_percentage: 0,
                    last_updated: new Date().toISOString()
                };
                
                const { data, error: insertError } = await supabase
                    .from('current_context')
                    .insert(newContext)
                    .select()
                    .single();
                
                if (insertError) throw insertError;
                
                status.innerHTML = `
                <div class="success">
                    <h3>‚úÖ Success!</h3>
                    <p>New context created with proper timestamp.</p>
                    <p><strong>Timestamp:</strong> ${data.last_updated}</p>
                    <p>This should now show as "Just now" in your dashboard.</p>
                    <p>Refresh your dashboard to verify!</p>
                </div>`;
                
            } catch (error) {
                status.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>