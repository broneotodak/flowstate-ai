<!DOCTYPE html>
<html>
<head>
    <title>Debug Current Context</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
    <style>
        body {
            font-family: monospace;
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
        }
        .section {
            background: #f5f5f5;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        button {
            background: #2196f3;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            margin: 5px;
        }
        .success { color: green; }
        .error { color: red; }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        pre {
            background: #e0e0e0;
            padding: 10px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>üîç Debug Current Context</h1>
    
    <input type="password" id="serviceKey" placeholder="Service Role Key">
    <br><br>
    <button onclick="debugContext()">Debug Context Table</button>
    <button onclick="fixContext()">Force Fix Context</button>
    <button onclick="checkActivities()">Check Recent Activities</button>
    
    <div id="results"></div>

    <script>
        const SUPABASE_URL = 'https://uzamamymfzhelvkwpvgt.supabase.co';
        document.getElementById('serviceKey').value = localStorage.getItem('flowstate_service_key') || '';
        
        async function debugContext() {
            const serviceKey = document.getElementById('serviceKey').value;
            if (!serviceKey) return alert('Enter service key');
            
            const supabase = window.supabase.createClient(SUPABASE_URL, serviceKey);
            const results = document.getElementById('results');
            
            // Get ALL records from current_context
            const { data: allContexts, error } = await supabase
                .from('current_context')
                .select('*')
                .order('last_updated', { ascending: false });
            
            let html = '<div class="section"><h2>All Records in current_context table:</h2>';
            
            if (error) {
                html += `<p class="error">Error: ${error.message}</p>`;
            } else {
                html += '<table>';
                html += '<tr><th>User ID</th><th>Project</th><th>Task</th><th>Last Updated</th><th>ID</th></tr>';
                
                allContexts.forEach(ctx => {
                    const isOld = new Date() - new Date(ctx.last_updated) > 3600000; // 1 hour
                    html += `<tr class="${isOld ? 'error' : 'success'}">`;
                    html += `<td>${ctx.user_id}</td>`;
                    html += `<td><strong>${ctx.project_name}</strong></td>`;
                    html += `<td>${ctx.current_task}</td>`;
                    html += `<td>${new Date(ctx.last_updated).toLocaleString()}</td>`;
                    html += `<td>${ctx.id}</td>`;
                    html += '</tr>';
                });
                html += '</table>';
                
                if (allContexts.length > 1) {
                    html += '<p class="error">‚ö†Ô∏è Multiple records found! This might cause issues.</p>';
                }
            }
            
            // Get what the dashboard actually queries
            const { data: dashboardContext } = await supabase
                .from('current_context')
                .select('*')
                .eq('user_id', 'neo_todak')
                .single();
            
            html += '</div><div class="section"><h2>What Dashboard Sees (user_id=neo_todak):</h2>';
            html += '<pre>' + JSON.stringify(dashboardContext, null, 2) + '</pre>';
            html += '</div>';
            
            results.innerHTML = html;
        }
        
        async function fixContext() {
            const serviceKey = document.getElementById('serviceKey').value;
            if (!serviceKey) return alert('Enter service key');
            
            const supabase = window.supabase.createClient(SUPABASE_URL, serviceKey);
            const results = document.getElementById('results');
            
            // Delete all old contexts first
            const { error: deleteError } = await supabase
                .from('current_context')
                .delete()
                .neq('user_id', 'impossible'); // Delete all
            
            // Insert fresh context
            const newContext = {
                user_id: 'neo_todak',
                project_name: 'flowstate-ai',
                current_task: 'Fix refreshGitHub event handling error',
                current_phase: 'Development',
                last_updated: new Date().toISOString()
            };
            
            const { data, error } = await supabase
                .from('current_context')
                .insert(newContext)
                .select()
                .single();
            
            if (error) {
                results.innerHTML = `<div class="section error">Error: ${error.message}</div>`;
            } else {
                results.innerHTML = `
                <div class="section success">
                    <h2>‚úÖ Context Fixed!</h2>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                    <p>Now refresh your dashboard (Cmd+Shift+R) to see the update!</p>
                </div>`;
            }
        }
        
        async function checkActivities() {
            const serviceKey = document.getElementById('serviceKey').value;
            if (!serviceKey) return alert('Enter service key');
            
            const supabase = window.supabase.createClient(SUPABASE_URL, serviceKey);
            const results = document.getElementById('results');
            
            const { data: activities, error } = await supabase
                .from('activities')
                .select('*')
                .eq('user_id', 'neo_todak')
                .order('created_at', { ascending: false })
                .limit(10);
            
            let html = '<div class="section"><h2>Recent Activities:</h2>';
            if (error) {
                html += `<p class="error">Error: ${error.message}</p>`;
            } else {
                html += '<table>';
                html += '<tr><th>Time</th><th>Type</th><th>Description</th><th>Project</th></tr>';
                activities?.forEach(act => {
                    html += '<tr>';
                    html += `<td>${new Date(act.created_at).toLocaleString()}</td>`;
                    html += `<td>${act.activity_type}</td>`;
                    html += `<td>${act.description}</td>`;
                    html += `<td>${act.project_name}</td>`;
                    html += '</tr>';
                });
                html += '</table>';
            }
            html += '</div>';
            
            results.innerHTML = html;
        }
    </script>
</body>
</html>