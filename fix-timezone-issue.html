<!DOCTYPE html>
<html>
<head>
    <title>Fix Timezone Issue</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
        }
        button {
            background: #2196f3;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px 0;
            display: block;
            width: 100%;
        }
        button:hover { background: #1976d2; }
        .status {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .success { color: #4caf50; }
        .error { color: #f44336; }
        input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin: 10px 0;
        }
        pre {
            background: #e0e0e0;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>üïê Fix FlowState Timezone Issue</h1>
    
    <input type="password" id="serviceKey" placeholder="Service Role Key">
    
    <button onclick="fixTimezone()">Fix Timezone & Update Context</button>
    <button onclick="updateGitHooks()">Update Git Hooks to Use UTC</button>
    
    <div id="status"></div>

    <script>
        const SUPABASE_URL = 'https://uzamamymfzhelvkwpvgt.supabase.co';
        document.getElementById('serviceKey').value = localStorage.getItem('flowstate_service_key') || '';
        
        async function fixTimezone() {
            const serviceKey = document.getElementById('serviceKey').value;
            if (!serviceKey) return alert('Enter service key');
            
            const supabase = window.supabase.createClient(SUPABASE_URL, serviceKey);
            const status = document.getElementById('status');
            
            try {
                // Update with proper UTC timestamp
                const utcNow = new Date().toISOString(); // This ensures UTC format with Z
                
                const { data, error } = await supabase
                    .from('current_context')
                    .update({
                        last_updated: utcNow,
                        project_name: 'flowstate-ai',
                        current_task: 'Fixed timezone issue for automated tracking'
                    })
                    .eq('user_id', 'neo_todak')
                    .select()
                    .single();
                
                if (error) throw error;
                
                status.innerHTML = `
                <div class="status">
                    <h3 class="success">‚úÖ Timezone Fixed!</h3>
                    <p><strong>Updated to:</strong> ${utcNow}</p>
                    <p><strong>This will display as:</strong> Just now</p>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                    <p>Refresh your dashboard to see the correct time!</p>
                </div>`;
                
            } catch (error) {
                status.innerHTML = `<div class="status error">Error: ${error.message}</div>`;
            }
        }
        
        function updateGitHooks() {
            const status = document.getElementById('status');
            status.innerHTML = `
            <div class="status">
                <h3>Update Git Hooks for UTC Timestamps</h3>
                <p>Edit <code>.git/hooks/flowstate-track.sh</code> and change line ~24:</p>
                <pre>
# From:
"created_at": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"

# To (ensure UTC with Z suffix):
"created_at": "$(date -u +"%Y-%m-%dT%H:%M:%S.%3NZ")"</pre>
                <p>And line ~43:</p>
                <pre>
# From:
"last_updated": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"

# To:
"last_updated": "$(date -u +"%Y-%m-%dT%H:%M:%S.%3NZ")"</pre>
                <p>This ensures all timestamps include milliseconds and proper UTC format.</p>
            </div>`;
        }
    </script>
</body>
</html>