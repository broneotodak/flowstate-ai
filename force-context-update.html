<!DOCTYPE html>
<html>
<head>
    <title>Force Context Update</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
        }
        .status { 
            padding: 20px; 
            background: #f5f5f5; 
            border-radius: 8px; 
            margin: 20px 0;
        }
        button {
            background: #2196f3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #1976d2; }
        input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin: 10px 0;
        }
        .success { color: #4caf50; }
        .error { color: #f44336; }
    </style>
</head>
<body>
    <h1>ðŸ”§ Force Context Update</h1>
    <p>Use this to manually refresh your FlowState context from the latest git activity.</p>
    
    <input type="password" id="serviceKey" placeholder="Service Role Key" value="">
    
    <button onclick="forceUpdate()">Force Update from Latest Activity</button>
    <button onclick="clearCache()">Clear Dashboard Cache</button>
    
    <div id="status" class="status"></div>

    <script>
        const SUPABASE_URL = 'https://uzamamymfzhelvkwpvgt.supabase.co';
        
        // Pre-fill service key if available
        document.getElementById('serviceKey').value = localStorage.getItem('flowstate_service_key') || '';
        
        async function forceUpdate() {
            const serviceKey = document.getElementById('serviceKey').value;
            if (!serviceKey) {
                alert('Please enter service key');
                return;
            }
            
            localStorage.setItem('flowstate_service_key', serviceKey);
            const supabase = window.supabase.createClient(SUPABASE_URL, serviceKey);
            const status = document.getElementById('status');
            
            try {
                // Get the latest activity
                const { data: latestActivity, error: actError } = await supabase
                    .from('activities')
                    .select('*')
                    .eq('user_id', 'neo_todak')
                    .order('created_at', { ascending: false })
                    .limit(1)
                    .single();
                
                if (actError) {
                    // No activities table, try to get from git commits
                    status.innerHTML = `<p class="error">Activities table issue: ${actError.message}</p>`;
                    status.innerHTML += '<p>Trying alternative update method...</p>';
                }
                
                // Force update current context
                const contextUpdate = {
                    user_id: 'neo_todak',
                    project_name: 'flowstate-ai',
                    current_task: latestActivity ? latestActivity.description : 'Working on FlowState improvements',
                    current_phase: 'Development',
                    last_updated: new Date().toISOString()
                };
                
                const { data: updated, error: updateError } = await supabase
                    .from('current_context')
                    .upsert(contextUpdate, {
                        onConflict: 'user_id'
                    });
                
                if (updateError) {
                    status.innerHTML = `<p class="error">Update error: ${updateError.message}</p>`;
                } else {
                    status.innerHTML = `
                        <p class="success">âœ… Context updated successfully!</p>
                        <p><strong>Project:</strong> ${contextUpdate.project_name}</p>
                        <p><strong>Task:</strong> ${contextUpdate.current_task}</p>
                        <p><strong>Updated:</strong> Just now</p>
                        <br>
                        <p>Refresh your dashboard to see the changes!</p>
                    `;
                    
                    // Also update the timestamp
                    await supabase.rpc('update_context_timestamp', {
                        p_user_id: 'neo_todak'
                    }).catch(() => {
                        // Function might not exist, that's OK
                    });
                }
                
            } catch (error) {
                status.innerHTML = `<p class="error">Error: ${error.message}</p>`;
            }
        }
        
        function clearCache() {
            // Clear any cached data
            localStorage.removeItem('flowstate_context_cache');
            localStorage.removeItem('flowstate_last_update');
            
            const status = document.getElementById('status');
            status.innerHTML = `
                <p class="success">âœ… Cache cleared!</p>
                <p>Now refresh your dashboard with Cmd+Shift+R (Mac) or Ctrl+Shift+F5 (Windows)</p>
            `;
        }
    </script>
</body>
</html>